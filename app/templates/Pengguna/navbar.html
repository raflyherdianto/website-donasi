<nav class="bg-blue-200 shadow-md px-6 py-4 flex justify-between items-center sticky top-0 z-40">
    <div class="flex items-center space-x-3">
        <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo Kabupaten Lumajang" class="w-10 h-10">
        <span class="text-xl md:text-2xl font-bold text-blue-700">KABUPATEN LUMAJANG</span>
    </div>

    <!-- Desktop Menu -->
    <div class="hidden md:flex space-x-6 items-center">
        <a href="{{ url_for('public.home') }}" class="text-{% if request.endpoint == 'public.home' %}blue-700 font-semibold{% else %}gray-700 hover:text-blue-600 font-medium{% endif %}">Beranda</a>

        <!-- Informasi Publik -->
        <div class="relative group">
            <button type="button" onclick="toggleDropdown(event, 'infoDropdown')" class="flex items-center text-gray-700 hover:text-blue-600 font-medium focus:outline-none">
                Informasi Publik
                <svg class="ml-1 w-4 h-4 fill-current" viewBox="0 0 20 20">
                    <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" fill-rule="evenodd"></path>
                </svg>
            </button>
            <div id="infoDropdown" class="dropdown-content mt-1 rounded-lg shadow-lg">
                <a href="{{ url_for('public.syarat') }}" class="block px-4 py-2 hover:bg-blue-50">Syarat & Ketentuan</a>
                {% if SessionManager.is_logged_in('user') %}
                <a href="{{ url_for('public.transparansi') }}" class="block px-4 py-2 hover:bg-blue-50">Transparansi Donasi</a>
                <a href="{{ url_for('public.riwayat') }}" class="block px-4 py-2 hover:bg-blue-50">Riwayat Transparansi</a>
                {% endif %}
            </div>
        </div>

        <a href="{{ url_for('public.perpusdes') }}" class="text-{% if request.endpoint == 'public.perpusdes' %}blue-700 font-semibold{% else %}gray-700 hover:text-blue-600 font-medium{% endif %}">Perpusdes</a>
        <a href="{{ url_for('public.panduan_donasi') }}" class="text-{% if request.endpoint == 'public.panduan_donasi' %}blue-700 font-semibold{% else %}gray-700 hover:text-blue-600 font-medium{% endif %}">Panduan Donasi</a>

        <!-- Tentang Kami -->
        <div class="relative group">
            <button type="button" onclick="toggleDropdown(event, 'aboutDropdown')" class="flex items-center text-gray-700 hover:text-blue-600 font-medium focus:outline-none">
                Tentang Kami
                <svg class="ml-1 w-4 h-4 fill-current" viewBox="0 0 20 20">
                    <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" fill-rule="evenodd"></path>
                </svg>
            </button>
            <div id="aboutDropdown" class="dropdown-content mt-1 rounded-lg shadow-lg">
                <a href="{{ url_for('public.faq') }}" class="block px-4 py-2 hover:bg-blue-50">FAQ</a>
                <a href="{{ url_for('public.kontak') }}" class="block px-4 py-2 hover:bg-blue-50">Kontak Kami</a>
                <a href="{{ url_for('public.profil') }}" class="block px-4 py-2 hover:bg-blue-50">Profil</a>
            </div>
        </div>

        <!-- User Login / Logout -->
        {% if SessionManager.is_logged_in('user') %}
        <div class="relative ml-4">
            <button onclick="toggleDropdown(event, 'profileDropdown')" class="flex items-center space-x-2 bg-white border border-gray-300 px-3 py-1 rounded hover:bg-gray-50 transition">
                <i class="fa-solid fa-circle-user text-gray-600 text-lg"></i>
                <span class="text-sm font-medium text-gray-700 truncate max-w-24">{{ SessionManager.get_specific_user_data('full_name', 'user') or 'User' }}</span>
                <svg class="w-4 h-4 text-gray-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </button>
            <div id="profileDropdown" class="dropdown-content profile-dropdown mt-1 rounded-lg shadow-lg">
                <a href="#" onclick="openProfileModal(event)" class="flex items-center px-4 py-2 text-gray-700 hover:bg-gray-50">
                    <svg class="w-4 h-4 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                    Ubah Profil
                </a>
                <a href="{{ url_for('public.logout') }}" class="flex items-center px-4 py-2 text-red-500 hover:bg-red-50">
                    <svg class="w-4 h-4 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                    Logout
                </a>
            </div>
        </div>
        {% else %}
        <a href="{{ url_for('public.login') }}" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition duration-200">
            Login
        </a>
        {% endif %}
    </div>

    <!-- Mobile Hamburger Button -->
    <div class="md:hidden flex items-center">
        <button onclick="toggleMobileMenu()" class="text-gray-700 focus:outline-none">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
        </button>
    </div>
</nav>

<!-- Mobile Menu -->
<div id="mobile-menu" class="hidden md:hidden bg-white shadow-md p-4 space-y-2">
    <a href="{{ url_for('public.home') }}" class="block text-gray-700 hover:text-blue-600">Beranda</a>
    <details class="group">
        <summary class="flex justify-between items-center cursor-pointer text-gray-700 hover:text-blue-600">
            Informasi Publik
            <svg class="w-4 h-4 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
        </summary>
        <div class="mt-2 pl-4 space-y-1">
            <a href="{{ url_for('public.syarat') }}" class="block text-sm text-gray-600 hover:text-blue-600">Syarat & Ketentuan</a>
            {% if SessionManager.is_logged_in('user') %}
            <a href="{{ url_for('public.transparansi') }}" class="block text-sm text-gray-600 hover:text-blue-600">Transparansi Donasi</a>
            <a href="{{ url_for('public.riwayat') }}" class="block text-sm text-gray-600 hover:text-blue-600">Riwayat Transparansi</a>
            {% endif %}
        </div>
    </details>
    <a href="{{ url_for('public.perpusdes') }}" class="block text-gray-700 hover:text-blue-600">Perpusdes</a>
    <a href="{{ url_for('public.panduan_donasi') }}" class="block text-gray-700 hover:text-blue-600">Panduan Donasi</a>
    <details class="group">
        <summary class="flex justify-between items-center cursor-pointer text-gray-700 hover:text-blue-600">
            Tentang Kami
            <svg class="w-4 h-4 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
        </summary>
        <div class="mt-2 pl-4 space-y-1">
            <a href="{{ url_for('public.faq') }}" class="block text-sm text-gray-600 hover:text-blue-600">FAQ</a>
            <a href="{{ url_for('public.kontak') }}" class="block text-sm text-gray-600 hover:text-blue-600">Kontak Kami</a>
            <a href="{{ url_for('public.profil') }}" class="block text-sm text-gray-600 hover:text-blue-600">Profil</a>
        </div>
    </details>
    {% if SessionManager.is_logged_in('user') %}
    <a href="#" onclick="openProfileModal(event)" class="block text-gray-700 hover:text-blue-600 px-2 py-1 rounded">Ubah Profil</a>
    <a href="{{ url_for('public.logout') }}" class="block text-red-500 hover:bg-red-50 px-2 py-1 rounded">Logout</a>
    {% else %}
    <a href="{{ url_for('public.login') }}" class="block text-blue-600 hover:bg-blue-50 px-2 py-1 rounded">Login</a>
    {% endif %}
</div>

<!-- Profile Edit Modal -->
<div id="profileModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-10 mx-auto p-5 border w-11/12 sm:w-2/3 md:w-1/2 lg:w-2/5 xl:w-1/3 shadow-lg rounded-md bg-white max-h-screen overflow-y-auto">
        <div class="mt-3">
            <!-- Modal Header -->
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-gray-900">Ubah Profil</h3>
                <button type="button" onclick="closeProfileModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>

            <!-- Profile Form -->
            <form id="profileForm" method="POST" action="{{ url_for('public.update_profile') }}">
                <div class="space-y-4">
                    <div>
                        <label for="profile_username" class="block text-sm font-medium text-gray-700 mb-1">
                            Username
                        </label>
                        <input type="text" id="profile_username" name="username" 
                               value="{{ SessionManager.get_specific_user_data('username', 'user') or '' }}"
                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="Masukkan username">
                    </div>
                    
                    <div>
                        <label for="profile_full_name" class="block text-sm font-medium text-gray-700 mb-1">
                            Nama Lengkap
                        </label>
                        <input type="text" id="profile_full_name" name="full_name" 
                               value="{{ SessionManager.get_specific_user_data('full_name', 'user') or '' }}"
                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="Masukkan nama lengkap">
                    </div>
                    
                    <div>
                        <label for="profile_email" class="block text-sm font-medium text-gray-700 mb-1">
                            Email
                        </label>
                        <input type="email" id="profile_email" name="email" 
                               value="{{ SessionManager.get_specific_user_data('email', 'user') or '' }}"
                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="Masukkan email">
                    </div>
                    
                    <div>
                        <label for="profile_password" class="block text-sm font-medium text-gray-700 mb-1">
                            Password Baru
                        </label>
                        <input type="password" id="profile_password" name="password" 
                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="Kosongkan jika tidak ingin mengubah password">
                        <p class="text-xs text-gray-500 mt-1">Kosongkan jika tidak ingin mengubah password</p>
                    </div>
                    
                    <div>
                        <label for="profile_confirm_password" class="block text-sm font-medium text-gray-700 mb-1">
                            Konfirmasi Password Baru
                        </label>
                        <input type="password" id="profile_confirm_password" name="confirm_password" 
                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="Konfirmasi password baru">
                        <p class="text-xs text-gray-500 mt-1">Wajib diisi jika mengubah password</p>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3 mt-6">
                    <button type="button" onclick="closeProfileModal()" 
                            class="w-full sm:w-auto bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded transition duration-200">
                        Batal
                    </button>
                    <button type="submit" 
                            class="w-full sm:w-auto bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded transition duration-200">
                        Simpan Perubahan
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function toggleDropdown(event, dropdownId) {
        event.preventDefault();
        const dropdown = document.getElementById(dropdownId);
        dropdown.classList.toggle('show-dropdown');
        document.querySelectorAll(".dropdown-content").forEach(el => {
            if (el !== dropdown) el.classList.remove("show-dropdown");
        });
    }

    function toggleMobileMenu() {
        const mobileMenu = document.getElementById('mobile-menu');
        mobileMenu.classList.toggle('hidden');
    }

    function openProfileModal(event) {
        event.preventDefault();
        const modal = document.getElementById('profileModal');
        if (modal) {
            modal.classList.remove('hidden');
            // Close any open dropdowns
            document.querySelectorAll(".dropdown-content").forEach(el => {
                el.classList.remove("show-dropdown");
            });
        }
    }

    function closeProfileModal() {
        const modal = document.getElementById('profileModal');
        if (modal) {
            modal.classList.add('hidden');
            // Reset form to original values
            const username = '{{ SessionManager.get_specific_user_data("username", "user") or "" }}';
            const fullName = '{{ SessionManager.get_specific_user_data("full_name", "user") or "" }}';
            const email = '{{ SessionManager.get_specific_user_data("email", "user") or "" }}';
            
            document.getElementById('profile_username').value = username;
            document.getElementById('profile_full_name').value = fullName;
            document.getElementById('profile_email').value = email;
            document.getElementById('profile_password').value = '';
            document.getElementById('profile_confirm_password').value = '';
        }
    }

    // Close dropdowns and mobile menu when clicking outside
    document.addEventListener('click', function (event) {
        const target = event.target;
        
        // Close profile dropdown
        const profileDropdown = document.getElementById('profileDropdown');
        if (profileDropdown && !target.closest('.relative') && !profileDropdown.contains(target)) {
            profileDropdown.classList.remove('show-dropdown');
        }

        // Close mobile menu
        const mobileMenu = document.getElementById('mobile-menu');
        if (mobileMenu && !target.closest('.md:hidden') && !mobileMenu.contains(target)) {
            mobileMenu.classList.add('hidden');
        }

        // Close profile modal when clicking outside
        const modal = document.getElementById('profileModal');
        if (modal && target === modal) {
            closeProfileModal();
        }
    });

    // Form validation for password confirmation
    document.addEventListener('DOMContentLoaded', function() {
        const profileForm = document.getElementById('profileForm');
        if (profileForm) {
            profileForm.addEventListener('submit', function(e) {
                const password = document.getElementById('profile_password').value;
                const confirmPassword = document.getElementById('profile_confirm_password').value;
                
                // Only validate password confirmation if password is being changed
                if (password && password !== confirmPassword) {
                    e.preventDefault();
                    // Use the global showToast function from base_public.html
                    if (typeof showToast === 'function') {
                        showToast('Password dan konfirmasi password tidak cocok', 'error');
                    } else {
                        alert('Password dan konfirmasi password tidak cocok');
                    }
                    return false;
                }
                
                if (password && password.length < 6) {
                    e.preventDefault();
                    if (typeof showToast === 'function') {
                        showToast('Password minimal 6 karakter', 'error');
                    } else {
                        alert('Password minimal 6 karakter');
                    }
                    return false;
                }
            });
        }
    });
</script>
