{% extends "pengguna/base_public.html" %}
{% from "pengguna/content_wrapper.html" import content_container, card, grid_container %}

{% block title %}
Transparansi Donasi - Donasi Buku Lumajang
{% endblock %}

{% block extra_head %}
<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css">
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<!-- DataTables JS -->
<script type="text/javascript" src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>

<style>
/* Custom DataTables Styling */
.dataTables_wrapper {
    font-family: inherit;
}

.dataTables_length select,
.dataTables_filter input {
    border: 1px solid #d1d5db;
    border-radius: 0.5rem;
    padding: 0.5rem;
    font-size: 0.875rem;
}

.dataTables_length,
.dataTables_filter,
.dataTables_info,
.dataTables_paginate {
    margin: 0.75rem 0;
}

.dataTables_length label,
.dataTables_filter label {
    font-weight: 500;
    color: #374151;
    margin-bottom: 0.25rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.dataTables_paginate .paginate_button {
    border: 1px solid #d1d5db !important;
    border-radius: 0.375rem !important;
    padding: 0.5rem 0.75rem !important;
    margin: 0 0.125rem !important;
    background: white !important;
    color: #374151 !important;
    text-decoration: none !important;
    transition: all 0.2s ease !important;
    display: inline-block !important;
    box-sizing: border-box !important;
}

.dataTables_paginate .paginate_button:hover {
    background: #3b82f6 !important;
    border-color: #9ca3af !important;
    color: #111827 !important;
    border-radius: 0.375rem !important;
    text-decoration: none !important;
}

.dataTables_paginate .paginate_button.current {
    background: #3b82f6 !important;
    border-color: #3b82f6 !important;
    color: white !important;
    border-radius: 0.375rem !important;
}

.dataTables_paginate .paginate_button.current:hover {
    background: #2563eb !important;
    border-color: #2563eb !important;
    color: white !important;
    border-radius: 0.375rem !important;
    text-decoration: none !important;
}

.dataTables_paginate .paginate_button.disabled {
    background: #f9fafb !important;
    border-color: #e5e7eb !important;
    color: #9ca3af !important;
    cursor: not-allowed !important;
    border-radius: 0.375rem !important;
}

.dataTables_paginate .paginate_button.disabled:hover {
    background: #f9fafb !important;
    border-color: #e5e7eb !important;
    color: #9ca3af !important;
    border-radius: 0.375rem !important;
    text-decoration: none !important;
}

.dataTables_paginate {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.125rem;
}

.dataTables_paginate .paginate_button a {
    border-radius: 0.375rem !important;
    text-decoration: none !important;
}

#transparansiTable {
    border-collapse: separate;
    border-spacing: 0;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    overflow: hidden;
}

#transparansiTable thead th {
    background: #f3f4f6;
    color: #374151;
    font-weight: 600;
    padding: 1rem;
    border-bottom: 1px solid #e5e7eb;
    position: relative;
}

#transparansiTable thead th.sorting:before,
#transparansiTable thead th.sorting:after,
#transparansiTable thead th.sorting_asc:before,
#transparansiTable thead th.sorting_asc:after,
#transparansiTable thead th.sorting_desc:before,
#transparansiTable thead th.sorting_desc:after {
    color: #6b7280;
}

#transparansiTable tbody td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #f3f4f6;
}

#transparansiTable tbody tr:hover {
    background: #f9fafb;
}

.dt-responsive {
    overflow-x: auto;
}

/* Ensure table container has horizontal scroll */
.dataTables_wrapper .dataTables_scroll {
    overflow: auto;
}

.dataTables_wrapper .dataTables_scrollBody {
    overflow: auto;
}

@media (max-width: 768px) {
    .dataTables_length,
    .dataTables_filter {
        text-align: center;
        margin-bottom: 1rem;
    }
    
    .dataTables_info,
    .dataTables_paginate {
        text-align: center;
        margin-top: 1rem;
    }
    
    .dataTables_paginate .paginate_button {
        padding: 0.375rem 0.5rem !important;
        font-size: 0.875rem !important;
    }
    
    /* Force horizontal scroll on mobile */
    #transparansiTable_wrapper .dataTables_scroll {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    /* Minimum width for table columns on mobile */
    #transparansiTable th,
    #transparansiTable td {
        min-width: 120px;
        white-space: nowrap;
    }
    
    /* Allow text wrapping for certain columns */
    #transparansiTable td:nth-child(4) { /* Subjek column */
        white-space: normal;
        word-break: break-word;
        min-width: 150px;
    }
}
</style>
{% endblock %}

{% block content %}
{% call content_container("7xl", "px-4 sm:px-6 py-10") %}
    <!-- Judul -->
    <div class="text-center mb-8 sm:mb-12">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-700 mb-4">Transparansi Donasi Buku</h1>
        <p class="text-gray-600 text-base sm:text-lg">Pantau alur dan penggunaan secara real-time. Kami berkomitmen menjaga transparansi setiap bantuan yang diberikan oleh para donatur.</p>
    </div>

    <!-- Kotak Statistik -->
    {% call grid_container("grid-cols-1 sm:grid-cols-2 lg:grid-cols-3", "gap-6 sm:gap-8 mb-12") %}
        <!-- Total Buku -->
        {% call card(class="bg-blue-100 rounded-xl shadow-md p-6 flex flex-col items-center justify-center hover:shadow-lg transition-all") %}
            <svg class="w-8 h-8 text-blue-600 mb-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
            </svg>
            <p class="text-sm font-semibold text-blue-700 mb-2">Total Buku</p>
            <p class="text-2xl font-bold text-gray-800">{{ total_buku }}</p>
        {% endcall %}

        <!-- Perpustakaan Terbantu -->
        {% call card(class="bg-green-100 rounded-xl shadow-md p-6 flex flex-col items-center justify-center hover:shadow-lg transition-all") %}
            <svg class="w-8 h-8 text-green-600 mb-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
            </svg>
            <p class="text-sm font-semibold text-green-700 mb-2">Perpus Terbantu</p>
            <p class="text-2xl font-bold text-gray-800">{{ perpus_terbantu }}</p>
        {% endcall %}

        <!-- Buku Didistribusikan -->
        {% call card(class="bg-yellow-100 rounded-xl shadow-md p-6 flex flex-col items-center justify-center hover:shadow-lg transition-all") %}
            <svg class="w-8 h-8 text-yellow-600 mb-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
            </svg>
            <p class="text-sm font-semibold text-yellow-700 text-center mb-2">Buku Didistribusikan</p>
            <p class="text-2xl font-bold text-gray-800">{{ buku_didistribusikan }}</p>
        {% endcall %}
    {% endcall %}

    <!-- Penjelasan -->
    <div class="mb-8">
        <h2 class="text-lg sm:text-xl font-semibold text-gray-800 mb-4">Rekap Donasi:</h2>
        <p class="text-gray-600 text-sm sm:text-base">Berikut adalah ringkasan donasi yang telah disalurkan oleh Perpustakaan Pusat ke Perpustakaan Desa sesuai permintaan dan kebutuhan yang ada:</p>
    </div>

    <!-- Tabel -->
    {% if distribusi_list|default([]) %}
        <div class="bg-white rounded-xl shadow-md p-6">
            <div class="overflow-x-auto">
                <table id="transparansiTable" class="min-w-full bg-white display responsive nowrap" style="width:100%">
                    <thead>
                        <tr>
                            <th class="text-left">Perpustakaan</th>
                            <th class="text-left">Desa/Kecamatan</th>
                            <th class="text-left">Jumlah Buku</th>
                            <th class="text-left">Subjek</th>
                            <th class="text-left">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in distribusi_list %}
                        <tr>
                            <td class="font-medium text-gray-800">{{ item.perpus_nama }}</td>
                            <td class="text-gray-600">{{ item.lokasi }}</td>
                            <td class="text-gray-600">{{ item.total_buku }}</td>
                            <td class="text-gray-600">{{ item.subjek_list }}</td>
                            <td>
                                {% if item.status == 'Diterima' %}
                                <span class="inline-flex px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">
                                    {{ item.status }}
                                </span>
                                {% else %}
                                <span class="inline-flex px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-800 rounded-full">
                                    {{ item.status }}
                                </span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% else %}
        <div class="bg-gray-50 rounded-xl shadow-md p-8 sm:p-16 text-center">
            <div class="flex flex-col items-center">
                <svg class="w-12 h-12 text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <p class="text-sm sm:text-base text-gray-500">Belum ada distribusi donasi yang tersedia</p>
                <p class="text-xs sm:text-sm text-gray-400 mt-2">Data akan muncul setelah donasi Anda dikonfirmasi dan didistribusikan</p>
            </div>
        </div>
    {% endif %}
{% endcall %}
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    {% if distribusi_list|default([]) %}
    // Initialize DataTable
    var table = $('#transparansiTable').DataTable({
        responsive: true,
        pageLength: 10,
        lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "Semua"]],
        language: {
            search: "Cari:",
            lengthMenu: "Tampilkan _MENU_ entri",
            info: "Menampilkan _START_ sampai _END_ dari _TOTAL_ entri",
            infoEmpty: "Menampilkan 0 sampai 0 dari 0 entri",
            infoFiltered: "(disaring dari _MAX_ total entri)",
            paginate: {
                first: "Pertama",
                last: "Terakhir",
                next: '<i class="fa-solid fa-chevron-right"></i>',
                previous: '<i class="fa-solid fa-chevron-left"></i>'
            },
            emptyTable: "Tidak ada data yang tersedia",
            zeroRecords: "Tidak ditemukan data yang sesuai"
        },
        columnDefs: [
            { orderable: true, targets: [0, 1, 2, 3, 4] },
            { 
                targets: [2], // Jumlah Buku column
                type: 'num',
                render: function(data, type, row) {
                    if (type === 'display' || type === 'type') {
                        return data;
                    }
                    return parseInt(data) || 0;
                }
            }
        ],
        order: [[0, 'asc']],
        dom: '<"flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4"lf>rt<"flex flex-col sm:flex-row sm:items-center sm:justify-between mt-4"ip>',
        scrollX: true,
        autoWidth: false
    });
    
    // Ensure responsive behavior
    $(window).on('resize', function() {
        table.columns.adjust().responsive.recalc();
    });
    {% endif %}
});
</script>
{% endblock %}
