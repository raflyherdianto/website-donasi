{% extends "superadmin/base_superadmin.html" %}
{% from "superadmin/content_wrapper.html" import page_header, card, data_table, action_button %}

{% block title %}Kelola Donasi{% endblock %}

{% block extra_head %}
<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.12.1/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.3.0/css/responsive.bootstrap5.min.css">
<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
  .action-buttons {
    display: flex;
    gap: 4px;
    justify-content: center;
    flex-wrap: wrap;
  }
  
  .action-btn {
    padding: 4px 8px;
    font-size: 12px;
    border-radius: 4px;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 32px;
    height: 28px;
  }
  
  .action-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }
  
  .action-btn-detail {
    background-color: #3b82f6;
    color: white;
  }
  
  .action-btn-detail:hover {
    background-color: #2563eb;
    color: white;
  }
  
  .action-btn-edit {
    background-color: #f59e0b;
    color: white;
  }
  
  .action-btn-edit:hover {
    background-color: #d97706;
    color: white;
  }
  
  .action-btn-delete {
    background-color: #ef4444;
    color: white;
  }
  
  .action-btn-delete:hover {
    background-color: #dc2626;
    color: white;
  }
  
  .status-badge {
    padding: 4px 12px;
    border-radius: 16px;
    font-size: 12px;
    font-weight: 600;
    text-transform: none;
    display: inline-block;
    text-align: center;
    min-width: 100px;
    white-space: nowrap;
  }
  
  .status-draft {
    background-color: #f3f4f6;
    color: #374151;
    border: 1px solid #d1d5db;
  }
  
  .status-pending {
    background-color: #fef3c7;
    color: #d97706;
    border: 1px solid #f59e0b;
  }
  
  .status-confirmed {
    background-color: #d1fae5;
    color: #065f46;
    border: 1px solid #10b981;
  }
  
  @media (max-width: 768px) {
    .action-buttons {
      flex-direction: column;
      gap: 2px;
    }
    
    .action-btn {
      width: 100%;
      justify-content: flex-start;
      gap: 6px;
      padding: 6px 8px;
      font-size: 11px;
    }
    
    .action-btn span {
      display: inline;
    }
  }
  
  @media (min-width: 769px) {
    .action-btn span {
      display: none;
    }
  }
  
  /* Enhanced DataTables styling */
  .dataTables_wrapper {
    font-family: inherit;
  }
  
  .dataTables_length select,
  .dataTables_filter input {
    border: 1px solid #d1d5db !important;
    border-radius: 6px !important;
    padding: 6px 12px !important;
    font-size: 14px !important;
    background-color: white !important;
  }
  
  .dataTables_length select:focus,
  .dataTables_filter input:focus {
    outline: none !important;
    border-color: #3b82f6 !important;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
  }
  
  .dataTables_length,
  .dataTables_filter {
    margin-bottom: 1rem;
  }
  
  .dataTables_length label,
  .dataTables_filter label {
    font-weight: 500;
    color: #374151;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .dataTables_info {
    font-size: 14px;
    color: #6b7280;
    font-weight: 500;
    padding: 8px 0;
  }
  
  /* ENHANCED PAGINATION STYLING */
  .dataTables_wrapper .dataTables_paginate {
    margin-top: 16px !important;
    display: flex !important;
    justify-content: flex-end !important;
    align-items: center !important;
    font-size: 14px !important;
  }
  
  .dataTables_wrapper .dataTables_paginate .paginate_button,
  .dataTables_wrapper .dataTables_paginate .paginate_button:link,
  .dataTables_wrapper .dataTables_paginate .paginate_button:visited,
  .dataTables_wrapper .dataTables_paginate .paginate_button:active {
    padding: 8px 12px !important;
    margin: 0 2px !important;
    border-radius: 6px !important;
    border: 1px solid #d1d5db !important;
    background: white !important;
    background-image: none !important;
    color: #374151 !important;
    font-weight: 500 !important;
    text-decoration: none !important;
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    min-width: 40px !important;
    height: 40px !important;
    font-size: 14px !important;
    transition: all 0.2s ease !important;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05) !important;
    cursor: pointer !important;
  }
  
  .dataTables_wrapper .dataTables_paginate .paginate_button:hover:not(.current):not(.disabled) {
    background: #f8fafc !important;
    background-image: none !important;
    border-color: #94a3b8 !important;
    color: #1e293b !important;
    transform: translateY(-1px) !important;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
  }
  
  .dataTables_wrapper .dataTables_paginate .paginate_button.current,
  .dataTables_wrapper .dataTables_paginate .paginate_button.current:link,
  .dataTables_wrapper .dataTables_paginate .paginate_button.current:visited,
  .dataTables_wrapper .dataTables_paginate .paginate_button.current:active,
  .dataTables_wrapper .dataTables_paginate .paginate_button.current:focus,
  .dataTables_wrapper .dataTables_paginate .paginate_button.current:hover {
    background: #3b82f6 !important;
    background-image: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important;
    background-color: #3b82f6 !important;
    border: 1px solid #2563eb !important;
    border-color: #2563eb !important;
    color: white !important;
    font-weight: 600 !important;
    box-shadow: 0 3px 12px rgba(59, 130, 246, 0.4) !important;
    transform: none !important;
    z-index: 10 !important;
    position: relative !important;
  }
  
  .dataTables_wrapper .dataTables_paginate .paginate_button.disabled,
  .dataTables_wrapper .dataTables_paginate .paginate_button.disabled:hover,
  .dataTables_wrapper .dataTables_paginate .paginate_button.disabled:link,
  .dataTables_wrapper .dataTables_paginate .paginate_button.disabled:visited {
    opacity: 0.4 !important;
    cursor: not-allowed !important;
    background: #f9fafb !important;
    background-image: none !important;
    border-color: #e5e7eb !important;
    color: #9ca3af !important;
    transform: none !important;
    box-shadow: none !important;
  }
  
  .dataTables_wrapper .dataTables_paginate .paginate_button.previous,
  .dataTables_wrapper .dataTables_paginate .paginate_button.next {
    background: #f1f5f9 !important;
    background-image: none !important;
    color: #475569 !important;
    border-color: #cbd5e1 !important;
    font-weight: 500 !important;
  }
  
  .dataTables_wrapper .dataTables_paginate .paginate_button.previous:hover:not(.disabled),
  .dataTables_wrapper .dataTables_paginate .paginate_button.next:hover:not(.disabled) {
    background: #e2e8f0 !important;
    background-image: none !important;
    border-color: #94a3b8 !important;
    color: #334155 !important;
  }
  
  .dataTables_wrapper .dataTables_paginate .ellipsis {
    padding: 8px 4px !important;
    color: #9ca3af !important;
    background: none !important;
    border: none !important;
    font-weight: 500 !important;
  }

  /* Status Cards Slider Styles - copied from pengajuan_perpusdes.html */
  .status-cards-container {
    position: relative;
    width: 100%;
    margin-bottom: 1.5rem;
  }
  
  .status-cards-wrapper {
    overflow-x: auto;
    scrollbar-width: none;
    -ms-overflow-style: none;
    scroll-behavior: smooth;
    padding: 0.25rem 0;
  }
  
  .status-cards-wrapper::-webkit-scrollbar {
    display: none;
  }
  
  .status-cards-grid {
    display: flex;
    gap: 0.75rem;
    min-width: max-content;
    padding: 0.25rem 0;
  }
  
  .status-card {
    background: white;
    border-radius: 10px;
    padding: 1rem;
    box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.06);
    border: 1px solid #e5e7eb;
    min-width: 160px;
    flex-shrink: 0;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }
  
  .status-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--card-color);
  }
  
  .status-card:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }
  
  .status-card.pending {
    --card-color: #f59e0b;
  }
  
  .status-card.confirmed {
    --card-color: #10b981;
  }
  
  .status-card-header {
    display: flex;
    items-center;
    justify-content: between;
    margin-bottom: 0.5rem;
  }
  
  .status-card-icon {
    width: 2.25rem;
    height: 2.25rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    color: white;
    margin-right: 0.75rem;
    flex-shrink: 0;
  }
  
  .status-card.pending .status-card-icon {
    background: linear-gradient(135deg, #f59e0b, #d97706);
  }
  
  .status-card.confirmed .status-card-icon {
    background: linear-gradient(135deg, #10b981, #059669);
  }
  
  .status-card-content {
    flex: 1;
  }
  
  .status-card-title {
    font-size: 0.75rem;
    font-weight: 600;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.025em;
    margin-bottom: 0.125rem;
  }
  
  .status-card-number {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1f2937;
    line-height: 1;
    margin-bottom: 0.125rem;
  }
  
  .status-card-subtitle {
    font-size: 0.6875rem;
    color: #9ca3af;
    font-weight: 500;
  }
  
  .status-card-trend {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    font-size: 0.6875rem;
    color: var(--card-color);
    font-weight: 600;
  }
  
  /* Scroll Indicators */
  .scroll-indicator {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 2rem;
    height: 2rem;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 10;
    box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
    transition: all 0.2s ease;
    opacity: 0;
    pointer-events: none;
  }
  
  .scroll-indicator:hover {
    background: #f3f4f6;
    transform: translateY(-50%) scale(1.05);
  }
  
  .scroll-indicator.left {
    left: -1rem;
  }
  
  .scroll-indicator.right {
    right: -1rem;
  }
  
  .status-cards-container:hover .scroll-indicator {
    opacity: 1;
    pointer-events: auto;
  }
  
  /* Responsive Design */
  @media (min-width: 768px) {
    .status-cards-grid {
      justify-content: center;
    }
    
    .status-card {
      min-width: 180px;
    }
  }
  
  @media (min-width: 1024px) {
    .status-cards-grid {
      justify-content: space-between;
      flex-wrap: wrap;
    }
    
    .status-card {
      flex: 1;
      max-width: 200px;
      min-width: 180px;
    }
  }
  
  @media (max-width: 640px) {
    .status-card {
      min-width: 140px;
      padding: 0.875rem;
    }
    
    .status-card-number {
      font-size: 1.375rem;
    }
    
    .status-card-icon {
      width: 2rem;
      height: 2rem;
      font-size: 0.875rem;
      margin-right: 0.5rem;
    }
    
    .status-card-title {
      font-size: 0.6875rem;
    }
    
    .status-card-subtitle {
      font-size: 0.625rem;
    }
  }
  
  /* Add disabled field styling */
  .field-disabled {
    background-color: #f9fafb !important;
    color: #6b7280 !important;
    cursor: not-allowed !important;
    opacity: 0.7;
  }
  
  .field-disabled:focus {
    box-shadow: none !important;
    border-color: #d1d5db !important;
  }
</style>
{% endblock %}

{% block content %}
{{ page_header("Kelola Donasi", "Kelola dan pantau semua donasi buku yang masuk ke sistem.") }}

<!-- Status Cards Section -->
<div class="status-cards-container">
  <div class="scroll-indicator left" onclick="scrollCards('left')">
    <i class="fas fa-chevron-left text-gray-600"></i>
  </div>
  
  <div class="status-cards-wrapper" id="statusCardsWrapper">
    <div class="status-cards-grid">
      <!-- Draft Card -->
      <div class="status-card" style="--card-color: #6b7280;">
        <div class="status-card-trend">
          <i class="fas fa-file-alt"></i>
        </div>
        <div class="status-card-header">
          <div class="status-card-icon" style="background: linear-gradient(135deg, #6b7280, #4b5563);">
            <i class="fas fa-file-alt"></i>
          </div>
          <div class="status-card-content">
            <div class="status-card-title">Draft</div>
            <div class="status-card-number">{{ stats_donasi.draft or 0 }}</div>
            <div class="status-card-subtitle">Donasi</div>
          </div>
        </div>
      </div>
      
      <!-- Pending Card -->
      <div class="status-card pending">
        <div class="status-card-trend">
          <i class="fas fa-truck"></i>
        </div>
        <div class="status-card-header">
          <div class="status-card-icon">
            <i class="fas fa-shipping-fast"></i>
          </div>
          <div class="status-card-content">
            <div class="status-card-title">Pengiriman</div>
            <div class="status-card-number">{{ stats_donasi.pending or 0 }}</div>
            <div class="status-card-subtitle">Donasi</div>
          </div>
        </div>
      </div>
      
      <!-- Confirmed Card -->
      <div class="status-card confirmed">
        <div class="status-card-trend">
          <i class="fas fa-check"></i>
        </div>
        <div class="status-card-header">
          <div class="status-card-icon">
            <i class="fas fa-check-circle"></i>
          </div>
          <div class="status-card-content">
            <div class="status-card-title">Diterima</div>
            <div class="status-card-number">{{ stats_donasi.confirmed or 0 }}</div>
            <div class="status-card-subtitle">Donasi</div>
          </div>
        </div>
      </div>
      
      <!-- Total Books Card -->
      <div class="status-card" style="--card-color: #6366f1;">
        <div class="status-card-trend">
          <i class="fas fa-book"></i>
        </div>
        <div class="status-card-header">
          <div class="status-card-icon" style="background: linear-gradient(135deg, #6366f1, #4f46e5);">
            <i class="fas fa-book"></i>
          </div>
          <div class="status-card-content">
            <div class="status-card-title">Total Buku</div>
            <div class="status-card-number">{{ stats_donasi.total_books or 0 }}</div>
            <div class="status-card-subtitle">Terkonfirmasi</div>
          </div>
        </div>
      </div>
      
      <!-- Total Donations Card -->
      <div class="status-card" style="--card-color: #8b5cf6;">
        <div class="status-card-trend">
          <i class="fas fa-chart-bar"></i>
        </div>
        <div class="status-card-header">
          <div class="status-card-icon" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
            <i class="fas fa-heart"></i>
          </div>
          <div class="status-card-content">
            <div class="status-card-title">Total</div>
            <div class="status-card-number">{{ stats_donasi.total or 0 }}</div>
            <div class="status-card-subtitle">Donasi Terkonfirmasi</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="scroll-indicator right" onclick="scrollCards('right')">
    <i class="fas fa-chevron-right text-gray-600"></i>
  </div>
</div>

{% if donasi_list %}
    {% call card("Data Donasi") %}
        <!-- DataTable Container -->
        <div class="overflow-x-auto">
            <table id="donasiTable" class="min-w-full text-sm text-gray-700 table-auto">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="px-4 py-3 text-left font-medium text-gray-700">Invoice</th>
                        <th class="px-4 py-3 text-left font-medium text-gray-700">Donatur</th>
                        <th class="px-4 py-3 text-left font-medium text-gray-700">Subjek Buku</th>
                        <th class="px-4 py-3 text-center font-medium text-gray-700">Jumlah Buku</th>
                        <th class="px-4 py-3 text-center font-medium text-gray-700">Status</th>
                        <th class="px-4 py-3 text-center font-medium text-gray-700">Tanggal</th>
                        <th class="px-4 py-3 text-center font-medium text-gray-700">Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    {% for donasi in donasi_list %}
                    <tr class="border-b hover:bg-gray-50 transition-colors">
                        <td class="px-4 py-3 font-medium">{{ donasi.invoice or 'INV-' + donasi.id|string }}</td>
                        <td class="px-4 py-3">{{ donasi.user.full_name if donasi.user else 'Tidak diketahui' }}</td>
                        <td class="px-4 py-3">{{ donasi.subjek_buku }}</td>
                        <td class="px-4 py-3 text-center">{{ donasi.jumlah_buku }}</td>
                        <td class="px-4 py-3 text-center">
                            {% if donasi.status == 'draft' %}
                                <span class="status-badge status-draft">Belum Konfirmasi</span>
                            {% elif donasi.status == 'pending' %}
                                <span class="status-badge status-pending">Pengiriman</span>
                            {% elif donasi.status == 'confirmed' %}
                                <span class="status-badge status-confirmed">Diterima</span>
                            {% else %}
                                <span class="status-badge status-draft">{{ donasi.status|title }}</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-center">{{ donasi.created_at.strftime('%d/%m/%Y') if donasi.created_at else '-' }}</td>
                        <td class="px-4 py-3 text-center">
                            <div class="action-buttons">
                                <button onclick="showDetailModal({{ donasi.id }})" 
                                        class="action-btn action-btn-detail"
                                        title="Detail">
                                    <i class="fas fa-eye"></i>
                                    <span>Detail</span>
                                </button>
                                {% if donasi.status != 'draft' %}
                                <button onclick="showEditModal({{ donasi.id }})" 
                                        class="action-btn action-btn-edit"
                                        title="Edit">
                                    <i class="fas fa-edit"></i>
                                    <span>Edit</span>
                                </button>
                                {% endif %}
                                <button onclick="showDeleteModal({{ donasi.id }}, '{{ donasi.invoice or 'INV-' + donasi.id|string }}')" 
                                        class="action-btn action-btn-delete"
                                        title="Hapus">
                                    <i class="fas fa-trash"></i>
                                    <span>Hapus</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% endcall %}
{% else %}
    {% call card() %}
        <div class="text-center py-8">
            <i class="fas fa-heart text-4xl text-gray-400 mb-4"></i>
            <h3 class="text-lg font-medium text-gray-600 mb-2">Belum Ada Data Donasi</h3>
            <p class="text-gray-500">Belum ada donasi yang terdaftar dalam sistem.</p>
        </div>
    {% endcall %}
{% endif %}

<!-- Modal Detail -->
<div id="detailModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-2/3 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-gray-900">Detail Donasi</h3>
                <button type="button" onclick="closeModal('detailModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            <div id="detailContent">
                <!-- Content will be loaded dynamically -->
            </div>
        </div>
    </div>
</div>

<!-- Modal Edit -->
<div id="editModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-2/3 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-gray-900">Edit Donasi</h3>
                <button type="button" onclick="closeModal('editModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            <form id="editForm" method="POST" enctype="multipart/form-data">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div>
                            <h4 class="text-md font-medium text-gray-700 mb-3">Informasi Donasi</h4>
                            <div id="edit_donasi_info" class="space-y-2 text-sm">
                                <!-- Donasi info will be loaded here -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label for="edit_status" class="block text-sm font-medium text-gray-700 mb-1">
                                Status Donasi <span class="text-red-500">*</span>
                            </label>
                            <select id="edit_status" name="status" required
                                    class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="pending">Pengiriman</option>
                                <option value="confirmed">Diterima</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="edit_sertifikat" class="block text-sm font-medium text-gray-700 mb-1">
                                Sertifikat Donasi <span class="text-red-500">*</span>
                            </label>
                            <input type="file" id="edit_sertifikat" name="sertifikat" accept=".png,.jpg,.jpeg" required
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                            <p class="text-xs text-gray-500 mt-1">Format: PNG, JPG, JPEG. Maksimal 2MB. <span class="text-red-500">Wajib diisi.</span></p>
                            <div id="current_sertifikat" class="mt-2"></div>
                            <div id="file_error" class="text-red-500 text-xs mt-1 hidden">File melebihi batas maksimal 2MB</div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6">
                    <h4 class="text-md font-medium text-gray-700 mb-3">Detail Donasi Buku</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-2 text-left">Subjek</th>
                                    <th class="px-3 py-2 text-center">Jumlah</th>
                                    <th class="px-3 py-2 text-center">Diterima</th>
                                    <th class="px-3 py-2 text-center">Ditolak</th>
                                    <th class="px-3 py-2 text-left">Alasan Ditolak</th>
                                </tr>
                            </thead>
                            <tbody id="edit_detail_items">
                                <!-- Detail rows with input fields will be loaded dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeModal('editModal')" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
                        Batal
                    </button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                        Simpan Perubahan
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Delete -->
<div id="deleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/3 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Konfirmasi Hapus</h3>
            <p class="text-sm text-gray-500 mb-4">
                Apakah Anda yakin ingin menghapus donasi "<span id="deleteDonasiName" class="font-semibold"></span>"?
            </p>
            <p class="text-xs text-red-600 mb-6">Tindakan ini tidak dapat dibatalkan!</p>
            <div class="flex justify-center space-x-3">
                <button type="button" onclick="closeModal('deleteModal')" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
                    Batal
                </button>
                <button type="button" id="confirmDeleteBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">
                    Ya, Hapus
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- DataTables JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.12.1/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.3.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.3.0/js/responsive.bootstrap5.min.js"></script>

<script>
$(document).ready(function() {
    // Initialize DataTables
    var table = $('#donasiTable').DataTable({
        responsive: true,
        language: {
            url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/id.json',
            lengthMenu: "Tampilkan _MENU_ entri",
            search: "Cari:",
            info: "Menampilkan _START_ sampai _END_ dari _TOTAL_ entri",
            infoEmpty: "Menampilkan 0 sampai 0 dari 0 entri",
            infoFiltered: "(disaring dari _MAX_ total entri)",
            emptyTable: "Tidak ada data yang tersedia dalam tabel",
            zeroRecords: "Tidak ada catatan yang cocok ditemukan",
            paginate: {
                first: "Pertama",
                last: "Terakhir",
                next: '<i class="fa-solid fa-chevron-right"></i>',
                previous: '<i class="fa-solid fa-chevron-left"></i>'
            }
        },
        columnDefs: [
            { orderable: false, targets: [0, 7] },
            { className: "text-center", targets: [4, 5, 6, 7] }
        ],
        order: [[6, 'desc']],  // urutkan berdasarkan kolom Tanggal (indeks 6)
        pageLength: 10,
        lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "Semua"]],
        dom: '<"flex flex-col lg:flex-row lg:items-center lg:justify-between mb-6 gap-4"<"flex-1"l><"flex-1 lg:text-right"f>>rtip',
        drawCallback: function() {
            applyPaginationStyling();
        },
        initComplete: function() {
            $('.dataTables_length select').addClass('border-2 focus:border-blue-500');
            $('.dataTables_filter input').addClass('border-2 focus:border-blue-500').attr('placeholder', 'Masukkan kata kunci...');
            setTimeout(applyPaginationStyling, 100);
        }
    });
    
    // Handle pagination clicks
    $(document).on('click', '.dataTables_paginate .paginate_button', function() {
        setTimeout(applyPaginationStyling, 50);
    });
    
    table.on('page.dt', function() {
        setTimeout(applyPaginationStyling, 50);
    });
});

// Apply pagination styling
function applyPaginationStyling() {
    $('.dataTables_paginate .paginate_button').removeClass('pagination-active-override force-current-style');
    
    $('.dataTables_paginate .paginate_button').each(function() {
        var $btn = $(this);
        if (!$btn.hasClass('current') && !$btn.hasClass('previous') && !$btn.hasClass('next') && !$btn.hasClass('disabled')) {
            $btn.css({
                'background': 'white',
                'background-image': 'none',
                'border': '1px solid #d1d5db',
                'color': '#374151',
                'font-weight': '500'
            });
        }
    });
    
    var currentButtons = $('.dataTables_paginate .paginate_button.current, .dataTables_paginate .paginate_button[aria-current="page"]');
    
    currentButtons.each(function() {
        var $btn = $(this);
        $btn.addClass('pagination-active-override force-current-style current');
        $btn.css({
            'background': '#3b82f6',
            'background-image': 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)',
            'background-color': '#3b82f6',
            'border': '1px solid #2563eb',
            'border-color': '#2563eb',
            'color': 'white',
            'font-weight': '600',
            'box-shadow': '0 3px 12px rgba(59, 130, 246, 0.4)',
            'transform': 'none',
            'z-index': '10',
            'position': 'relative'
        });
        $btn.attr('aria-current', 'page');
        $btn.attr('data-current', 'true');
    });
    
    customizePagination();
}

function customizePagination() {
    const prevButton = $('.dataTables_paginate .paginate_button.previous');
    const nextButton = $('.dataTables_paginate .paginate_button.next');
    
    if (prevButton.length && !prevButton.find('i').length) {
        prevButton.html('<i class="fa-solid fa-chevron-left mr-1"></i> Sebelumnya');
    }
    
    if (nextButton.length && !nextButton.find('i').length) {
        nextButton.html('Selanjutnya <i class="fa-solid fa-chevron-right ml-1"></i>');
    }
}

// Modal functions
function closeModal(modalId) {
    document.getElementById(modalId).classList.add('hidden');
}

function showDetailModal(donasiId) {
    fetch(`/superadmin/donasi/${donasiId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success !== false) {
                // Hitung total dari detail donasi
                const totalJumlah    = data.details.reduce((sum, d) => sum + (d.jumlah || 0), 0);
                const totalDiterima  = data.details.reduce((sum, d) => sum + (d.diterima || 0), 0);
                const totalDitolak   = data.details.reduce((sum, d) => sum + (d.ditolak || 0), 0);
                
                // Buat list alasan ditolak berdasarkan subjek buku
                const alasanPerSubjek = data.details
                    .filter(d => d.alasan_ditolak && d.alasan_ditolak.trim() !== '')
                    .map(d => `<li><strong>${d.item}:</strong> ${d.alasan_ditolak}</li>`)
                    .join('');
                
                const alasanHtml = alasanPerSubjek.length > 0
                    ? `<div><span class="font-medium">Alasan Ditolak:</span>
                        <ul class="list-disc list-inside text-sm mt-1 ml-4">
                          ${alasanPerSubjek}
                        </ul>
                      </div>`
                    : '<div><span class="font-medium">Alasan Ditolak:</span> Tidak ada</div>';
                
                let detailHtml = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-medium text-gray-700 mb-3">Informasi Donasi</h4>
                            <div class="space-y-2 text-sm">
                                <div><span class="font-medium">Invoice:</span> ${data.invoice || 'INV-' + data.id}</div>
                                <div><span class="font-medium">Status:</span> 
                                    ${data.status === 'draft' ? '<span class="status-badge status-draft">Belum Konfirmasi</span>' : 
                                      data.status === 'pending' ? '<span class="status-badge status-pending">Pengiriman</span>' : 
                                      data.status === 'confirmed' ? '<span class="status-badge status-confirmed">Diterima</span>' : 
                                      '<span class="status-badge status-draft">' + data.status + '</span>'}
                                </div>
                                <div><span class="font-medium">WhatsApp:</span> ${data.whatsapp || '-'}</div>
                                <div><span class="font-medium">Metode Pengiriman:</span> ${data.metode || '-'}</div>
                                <div><span class="font-medium">Jumlah Buku:</span> ${totalJumlah}</div>
                                <div><span class="font-medium">Total Diterima:</span> ${totalDiterima}</div>
                                <div><span class="font-medium">Total Ditolak:</span> ${totalDitolak}</div>
                                ${alasanHtml}
                            </div>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-700 mb-3">File & Dokumen</h4>
                            <div class="space-y-3 text-sm">
                                <div><span class="font-medium">Sampul Buku:</span><br> ${
                                    data.sampul_buku
                                      ? `<a href="/static/public/sampul-buku/${data.sampul_buku}" target="_blank" class="text-blue-600 hover:text-blue-800 underline">Lihat Sampul Buku</a>`
                                      : '<span class="text-gray-500">Tidak ada</span>'
                                }</div>
                                <div><span class="font-medium">Bukti Pengiriman:</span><br> ${
                                    data.bukti_pengiriman
                                      ? `<a href="/static/public/bukti-pengiriman/${data.bukti_pengiriman}" target="_blank" class="text-blue-600 hover:text-blue-800 underline">Lihat Bukti Pengiriman</a>`
                                      : '<span class="text-gray-500">Tidak ada</span>'
                                }</div>
                                <div><span class="font-medium">Sertifikat:</span><br> ${data.sertifikat ? 
                                    `<a href="/static/public/sertifikat-donasi/${data.sertifikat}" target="_blank" class="text-blue-600 hover:text-blue-800 underline">Lihat Sertifikat</a>` :
                                    '<span class="text-gray-500">Belum ada sertifikat</span>'
                                }</div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6">
                        <h4 class="font-medium text-gray-700 mb-3">Detail Donasi Buku</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-2 text-left">Subjek</th>
                                        <th class="px-3 py-2 text-center">Jumlah</th>
                                        <th class="px-3 py-2 text-center">Diterima</th>
                                        <th class="px-3 py-2 text-center">Ditolak</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                data.details.forEach(detail => {
                    detailHtml += `
                        <tr class="border-b">
                            <td class="px-3 py-2">${detail.item}</td>
                            <td class="px-3 py-2 text-center">${detail.jumlah}</td>
                            <td class="px-3 py-2 text-center">${detail.diterima || 0}</td>
                            <td class="px-3 py-2 text-center">${detail.ditolak || 0}</td>
                        </tr>
                    `;
                });
                
                detailHtml += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                document.getElementById('detailContent').innerHTML = detailHtml;
                document.getElementById('detailModal').classList.remove('hidden');
            } else {
                showToast(data.message || 'Gagal memuat detail donasi', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Gagal memuat detail donasi', 'error');
        });
}

function showEditModal(donasiId) {
    fetch(`/superadmin/donasi/${donasiId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success !== false) {
                // Fill form fields
                const statusSelect = document.getElementById('edit_status');
                statusSelect.value = data.status;
                
                // ✅ NEW: Make status field read-only if already confirmed
                if (data.status === 'confirmed') {
                    statusSelect.disabled = true;
                    statusSelect.classList.add('field-disabled');
                    
                    // Add a note explaining why it's disabled
                    const statusContainer = statusSelect.parentNode;
                    let existingNote = statusContainer.querySelector('.status-note');
                    if (!existingNote) {
                        const note = document.createElement('p');
                        note.className = 'status-note text-xs text-blue-600 mt-1 font-medium';
                        note.innerHTML = '<i class="fas fa-info-circle mr-1"></i>Status sudah dikonfirmasi dan tidak dapat diubah';
                        statusContainer.appendChild(note);
                    }
                } else {
                    // Enable status field if not confirmed
                    statusSelect.disabled = false;
                    statusSelect.classList.remove('field-disabled');
                    
                    // Remove note if exists
                    const statusContainer = statusSelect.parentNode;
                    const existingNote = statusContainer.querySelector('.status-note');
                    if (existingNote) {
                        existingNote.remove();
                    }
                }
                
                // Handle certificate requirement based on existing certificate
                const certInput = document.getElementById('edit_sertifikat');
                const currentCertDiv = document.getElementById('current_sertifikat');
                
                if (data.sertifikat) {
                    // If certificate exists, make it optional
                    certInput.required = false;
                    currentCertDiv.innerHTML = `
                        <div class="text-sm text-gray-600">
                            <span class="font-medium">Sertifikat saat ini:</span><br>
                            <img src="/static/public/sertifikat-donasi/${data.sertifikat}" alt="Sertifikat" class="mt-2 max-w-xs h-auto rounded border">
                        </div>
                    `;
                } else {
                    // If no certificate exists, make it required
                    certInput.required = true;
                    currentCertDiv.innerHTML = '<p class="text-sm text-gray-500">Belum ada sertifikat - Wajib upload sertifikat baru</p>';
                }
                
                // Show donasi info (like in detail modal)
                const totalJumlah = data.details.reduce((sum, d) => sum + (d.jumlah || 0), 0);
                const totalDiterima = data.details.reduce((sum, d) => sum + (d.diterima || 0), 0);
                const totalDitolak = data.details.reduce((sum, d) => sum + (d.ditolak || 0), 0);
                
                document.getElementById('edit_donasi_info').innerHTML = `
                    <div><span class="font-medium">Invoice:</span> ${data.invoice || 'INV-' + data.id}</div>
                    <div><span class="font-medium">WhatsApp:</span> ${data.whatsapp || '-'}</div>
                    <div><span class="font-medium">Metode Pengiriman:</span> ${data.metode || '-'}</div>
                    <div><span class="font-medium">Total Buku:</span> ${totalJumlah}</div>
                    <div><span class="font-medium">Total Diterima:</span> ${totalDiterima}</div>
                    <div><span class="font-medium">Total Ditolak:</span> ${totalDitolak}</div>
                `;
                
                // Load detail items with input fields
                let detailRows = '';
                data.details.forEach((detail, index) => {
                    detailRows += `
                        <tr class="border-b">
                            <td class="px-3 py-2">${detail.item}</td>
                            <td class="px-3 py-2 text-center">${detail.jumlah}</td>
                            <td class="px-3 py-2 text-center">
                                <input type="number" 
                                       name="detail_${detail.id}_diterima" 
                                       value="${detail.diterima || 0}" 
                                       min="0" 
                                       max="${detail.jumlah}"
                                       class="w-20 border border-gray-300 rounded px-2 py-1 text-center text-sm focus:ring-blue-500 focus:border-blue-500"
                                       onchange="updateTotals()">
                            </td>
                            <td class="px-3 py-2 text-center">
                                <input type="number" 
                                       name="detail_${detail.id}_ditolak" 
                                       value="${detail.ditolak || 0}" 
                                       min="0" 
                                       max="${detail.jumlah}"
                                       class="w-20 border border-gray-300 rounded px-2 py-1 text-center text-sm focus:ring-blue-500 focus:border-blue-500"
                                       onchange="updateTotals()">
                            </td>
                            <td class="px-3 py-2">
                                <textarea name="detail_${detail.id}_alasan_ditolak" 
                                          rows="2" 
                                          class="w-full border border-gray-300 rounded px-2 py-1 text-sm focus:ring-blue-500 focus:border-blue-500"
                                          placeholder="Alasan jika ditolak...">${detail.alasan_ditolak || ''}</textarea>
                            </td>
                        </tr>
                    `;
                });
                document.getElementById('edit_detail_items').innerHTML = detailRows;
                
                document.getElementById('editForm').action = `/superadmin/donasi/${donasiId}/edit`;
                document.getElementById('editModal').classList.remove('hidden');
            } else {
                showToast(data.message || 'Gagal memuat data donasi', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Gagal memuat data donasi', 'error');
        });
}

// Function to update totals in edit modal
function updateTotals() {
    const detailRows = document.querySelectorAll('#edit_detail_items tr');
    let totalDiterima = 0;
    let totalDitolak = 0;
    
    detailRows.forEach(row => {
        const diterimaInput = row.querySelector('input[name*="_diterima"]');
        const ditolakInput = row.querySelector('input[name*="_ditolak"]');
        
        if (diterimaInput) totalDiterima += parseInt(diterimaInput.value) || 0;
        if (ditolakInput) totalDitolak += parseInt(ditolakInput.value) || 0;
    });
    
    // Update the info display
    const infoDiv = document.getElementById('edit_donasi_info');
    const infoHTML = infoDiv.innerHTML;
    const updatedHTML = infoHTML
        .replace(/(Total Diterima:<\/span> )\d+/, `$1${totalDiterima}`)
        .replace(/(Total Ditolak:<\/span> )\d+/, `$1${totalDitolak}`);
    infoDiv.innerHTML = updatedHTML;
}

// Modal Delete
document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
    const donasiId = this.getAttribute('data-donasi-id');
    deleteDonasi(donasiId);
});

function showDeleteModal(donasiId, donasiName) {
    document.getElementById('deleteDonasiName').textContent = donasiName;
    document.getElementById('confirmDeleteBtn').setAttribute('data-donasi-id', donasiId);
    document.getElementById('deleteModal').classList.remove('hidden');
}

function deleteDonasi(donasiId) {
    fetch(`/superadmin/donasi/${donasiId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.ok) {
            showToast(data.msg, 'success');
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showToast(data.msg, 'error');
        }
        closeModal('deleteModal');
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Gagal menghapus donasi', 'error');
        closeModal('deleteModal');
    });
}

// Handle edit form submission
document.getElementById('editForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Validate file size
    const fileInput = document.getElementById('edit_sertifikat');
    const errorDiv = document.getElementById('file_error');
    
    if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        const maxSize = 2 * 1024 * 1024; // 2MB in bytes
        
        if (file.size > maxSize) {
            errorDiv.classList.remove('hidden');
            return;
        } else {
            errorDiv.classList.add('hidden');
        }
    }
    
    const formData = new FormData(this);
    const actionUrl = this.action;
    
    // ✅ NEW: If status field is disabled, manually add the current status value
    const statusSelect = document.getElementById('edit_status');
    if (statusSelect.disabled) {
        formData.set('status', statusSelect.value);
    }
    
    // Show loading state
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Menyimpan...';
    submitBtn.disabled = true;
    
    fetch(actionUrl, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.ok) {
            showToast(data.msg, 'success');
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showToast(data.msg, 'error');
        }
        closeModal('editModal');
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Gagal menyimpan perubahan', 'error');
    })
    .finally(() => {
        // Restore button state
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});

// Add file size validation on file input change
document.getElementById('edit_sertifikat').addEventListener('change', function(e) {
    const errorDiv = document.getElementById('file_error');
    
    if (this.files.length > 0) {
        const file = this.files[0];
        const maxSize = 2 * 1024 * 1024; // 2MB in bytes
        
        if (file.size > maxSize) {
            errorDiv.classList.remove('hidden');
            this.value = ''; // Clear the file input
        } else {
            errorDiv.classList.add('hidden');
        }
    }
});

// Status Cards Slider Functionality - copied from pengajuan_perpusdes.html
function scrollCards(direction) {
  const wrapper = document.getElementById('statusCardsWrapper');
  const cardWidth = 220; // Approximate card width including gap
  const scrollAmount = cardWidth * 2;
  
  if (direction === 'left') {
    wrapper.scrollBy({
      left: -scrollAmount,
      behavior: 'smooth'
    });
  } else if (direction === 'right') {
    wrapper.scrollBy({
      left: scrollAmount,
      behavior: 'smooth'
    });
  }
}

// Update scroll indicators visibility based on scroll position
function updateScrollIndicators() {
  const wrapper = document.getElementById('statusCardsWrapper');
  const leftIndicator = document.querySelector('.scroll-indicator.left');
  const rightIndicator = document.querySelector('.scroll-indicator.right');
  
  if (wrapper.scrollLeft <= 0) {
    leftIndicator.style.opacity = '0';
    leftIndicator.style.pointerEvents = 'none';
  } else {
    leftIndicator.style.opacity = '1';
    leftIndicator.style.pointerEvents = 'auto';
  }
  
  if (wrapper.scrollLeft >= wrapper.scrollWidth - wrapper.clientWidth) {
    rightIndicator.style.opacity = '0';
    rightIndicator.style.pointerEvents = 'none';
  } else {
    rightIndicator.style.opacity = '1';
    rightIndicator.style.pointerEvents = 'auto';
  }
}

// Initialize scroll indicators
document.addEventListener('DOMContentLoaded', function() {
  const wrapper = document.getElementById('statusCardsWrapper');
  
  // Check if scroll is needed
  if (wrapper.scrollWidth <= wrapper.clientWidth) {
    document.querySelectorAll('.scroll-indicator').forEach(indicator => {
      indicator.style.display = 'none';
    });
  }
  
  // Add scroll event listener
  wrapper.addEventListener('scroll', updateScrollIndicators);
  
  // Initial check
  updateScrollIndicators();
});

// Touch/swipe support for mobile
let startX = 0;
let scrollLeft = 0;

document.getElementById('statusCardsWrapper').addEventListener('touchstart', function(e) {
  startX = e.touches[0].pageX - this.offsetLeft;
  scrollLeft = this.scrollLeft;
});

document.getElementById('statusCardsWrapper').addEventListener('touchmove', function(e) {
  e.preventDefault();
  const x = e.touches[0].pageX - this.offsetLeft;
  const walk = (x - startX) * 2;
  this.scrollLeft = scrollLeft - walk;
});
</script>
{% endblock %}
