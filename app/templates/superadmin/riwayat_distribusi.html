{% extends "superadmin/base_superadmin.html" %}
{% from "superadmin/content_wrapper.html" import page_header, card, data_table, action_button %}

{% block title %}Riwayat Distribusi{% endblock %}

{% block extra_head %}
<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.12.1/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.3.0/css/responsive.bootstrap5.min.css">
<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
  .action-buttons {
    display: flex;
    gap: 4px;
    justify-content: center;
    flex-wrap: wrap;
  }
  
  .action-btn {
    padding: 4px 8px;
    font-size: 12px;
    border-radius: 4px;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 32px;
    height: 28px;
  }
  
  .action-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }
  
  .action-btn-detail {
    background-color: #3b82f6;
    color: white;
  }
  
  .action-btn-detail:hover {
    background-color: #2563eb;
    color: white;
  }
  
  .action-btn-delete {
    background-color: #ef4444;
    color: white;
  }
  
  .action-btn-delete:hover {
    background-color: #dc2626;
    color: white;
  }
  
  @media (max-width: 768px) {
    .action-buttons {
      flex-direction: column;
      gap: 2px;
    }
    
    .action-btn {
      width: 100%;
      justify-content: flex-start;
      gap: 6px;
      padding: 6px 8px;
      font-size: 11px;
    }
    
    .action-btn span {
      display: inline;
    }
  }
  
  @media (min-width: 769px) {
    .action-btn span {
      display: none;
    }
  }
  
  /* Enhanced DataTables styling */
  .dataTables_wrapper {
    font-family: inherit;
  }
  
  .dataTables_length select,
  .dataTables_filter input {
    border: 1px solid #d1d5db !important;
    border-radius: 6px !important;
    padding: 6px 12px !important;
    font-size: 14px !important;
    background-color: white !important;
  }
  
  .dataTables_length select:focus,
  .dataTables_filter input:focus {
    outline: none !important;
    border-color: #3b82f6 !important;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
  }
  
  .dataTables_length,
  .dataTables_filter {
    margin-bottom: 1rem;
  }
  
  .dataTables_length label,
  .dataTables_filter label {
    font-weight: 500;
    color: #374151;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .dataTables_info {
    font-size: 14px;
    color: #6b7280;
    font-weight: 500;
    padding: 8px 0;
  }
  
  .dataTables_wrapper .dataTables_paginate {
    margin-top: 16px !important;
    display: flex !important;
    justify-content: flex-end !important;
    align-items: center !important;
    font-size: 14px !important;
  }
  
  .dataTables_wrapper .dataTables_paginate .paginate_button,
  .dataTables_wrapper .dataTables_paginate .paginate_button:link,
  .dataTables_wrapper .dataTables_paginate .paginate_button:visited,
  .dataTables_wrapper .dataTables_paginate .paginate_button:active {
    padding: 8px 12px !important;
    margin: 0 2px !important;
    border-radius: 6px !important;
    border: 1px solid #d1d5db !important;
    background: white !important;
    background-image: none !important;
    color: #374151 !important;
    font-weight: 500 !important;
    text-decoration: none !important;
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    min-width: 40px !important;
    height: 40px !important;
    font-size: 14px !important;
    transition: all 0.2s ease !important;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05) !important;
    cursor: pointer !important;
  }
  
  .dataTables_wrapper .dataTables_paginate .paginate_button:hover:not(.current):not(.disabled) {
    background: #f8fafc !important;
    background-image: none !important;
    border-color: #94a3b8 !important;
    color: #1e293b !important;
    transform: translateY(-1px) !important;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
  }
  
  .dataTables_wrapper .dataTables_paginate .paginate_button.current {
    background: #3b82f6 !important;
    background-image: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important;
    border: 1px solid #2563eb !important;
    color: white !important;
    font-weight: 600 !important;
    box-shadow: 0 3px 12px rgba(59, 130, 246, 0.4) !important;
  }
  
  .dataTables_wrapper .dataTables_paginate .paginate_button.disabled {
    opacity: 0.4 !important;
    cursor: not-allowed !important;
    background: #f9fafb !important;
    background-image: none !important;
    border-color: #e5e7eb !important;
    color: #9ca3af !important;
  }

  /* Status Cards Slider Styles - copied from donasi.html */
  .status-cards-container {
    position: relative;
    width: 100%;
    margin-bottom: 1.5rem;
  }
  
  .status-cards-wrapper {
    overflow-x: auto;
    scrollbar-width: none;
    -ms-overflow-style: none;
    scroll-behavior: smooth;
    padding: 0.25rem 0;
  }
  
  .status-cards-wrapper::-webkit-scrollbar {
    display: none;
  }
  
  .status-cards-grid {
    display: flex;
    gap: 0.75rem;
    min-width: max-content;
    padding: 0.25rem 0;
  }
  
  .status-card {
    background: white;
    border-radius: 10px;
    padding: 1rem;
    box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.06);
    border: 1px solid #e5e7eb;
    min-width: 160px;
    flex-shrink: 0;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    cursor: pointer;
  }
  
  .status-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--card-color);
  }
  
  .status-card:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }
  
  .status-card.pengiriman {
    --card-color: #f59e0b;
  }
  
  .status-card.diterima {
    --card-color: #10b981;
  }
  
  .status-card.kuota {
    --card-color: #6366f1;
  }
  
  .status-card-header {
    display: flex;
    align-items: center;
    justify-content: between;
    margin-bottom: 0.5rem;
  }
  
  .status-card-icon {
    width: 2.25rem;
    height: 2.25rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    color: white;
    margin-right: 0.75rem;
    flex-shrink: 0;
  }
  
  .status-card.pengiriman .status-card-icon {
    background: linear-gradient(135deg, #f59e0b, #d97706);
  }
  
  .status-card.diterima .status-card-icon {
    background: linear-gradient(135deg, #10b981, #059669);
  }
  
  .status-card.kuota .status-card-icon {
    background: linear-gradient(135deg, #6366f1, #4f46e5);
  }
  
  .status-card-content {
    flex: 1;
  }
  
  .status-card-title {
    font-size: 0.75rem;
    font-weight: 600;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.025em;
    margin-bottom: 0.125rem;
  }
  
  .status-card-number {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1f2937;
    line-height: 1;
    margin-bottom: 0.125rem;
  }
  
  .status-card-subtitle {
    font-size: 0.6875rem;
    color: #9ca3af;
    font-weight: 500;
  }
  
  .status-card-trend {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    font-size: 0.6875rem;
    color: var(--card-color);
    font-weight: 600;
  }
  
  /* Scroll Indicators */
  .scroll-indicator {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 2rem;
    height: 2rem;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 10;
    box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
    transition: all 0.2s ease;
    opacity: 0;
    pointer-events: none;
  }
  
  .scroll-indicator:hover {
    background: #f3f4f6;
    transform: translateY(-50%) scale(1.05);
  }
  
  .scroll-indicator.left {
    left: -1rem;
  }
  
  .scroll-indicator.right {
    right: -1rem;
  }
  
  .status-cards-container:hover .scroll-indicator {
    opacity: 1;
    pointer-events: auto;
  }
  
  /* Responsive Design */
  @media (min-width: 768px) {
    .status-cards-grid {
      justify-content: center;
    }
    
    .status-card {
      min-width: 180px;
    }
  }
  
  @media (min-width: 1024px) {
    .status-cards-grid {
      justify-content: space-between;
      flex-wrap: wrap;
    }
    
    .status-card {
      flex: 1;
      max-width: 200px;
      min-width: 180px;
    }
  }
  
  @media (max-width: 640px) {
    .status-card {
      min-width: 140px;
      padding: 0.875rem;
    }
    
    .status-card-number {
      font-size: 1.375rem;
    }
    
    .status-card-icon {
      width: 2rem;
      height: 2rem;
      font-size: 0.875rem;
      margin-right: 0.5rem;
    }
    
    .status-card-title {
      font-size: 0.6875rem;
    }
    
    .status-card-subtitle {
      font-size: 0.625rem;
    }
  }
</style>
{% endblock %}

{% block content %}
{{ page_header("Riwayat Distribusi", "Kelola dan pantau riwayat distribusi buku ke perpustakaan desa.") }}

<!-- Status Cards Section -->
<div class="status-cards-container">
  <div class="scroll-indicator left" onclick="scrollCards('left')">
    <i class="fas fa-chevron-left text-gray-600"></i>
  </div>
  
  <div class="status-cards-wrapper" id="statusCardsWrapper">
    <div class="status-cards-grid">
      <!-- Pengiriman Card -->
      <div class="status-card pengiriman">
        <div class="status-card-trend">
          <i class="fas fa-truck"></i>
        </div>
        <div class="status-card-header">
          <div class="status-card-icon">
            <i class="fas fa-shipping-fast"></i>
          </div>
          <div class="status-card-content">
            <div class="status-card-title">Pengiriman</div>
            <div class="status-card-number">{{ stats_distribusi.pengiriman or 0 }}</div>
            <div class="status-card-subtitle">Distribusi</div>
          </div>
        </div>
      </div>
      
      <!-- Diterima Card -->
      <div class="status-card diterima">
        <div class="status-card-trend">
          <i class="fas fa-check"></i>
        </div>
        <div class="status-card-header">
          <div class="status-card-icon">
            <i class="fas fa-check-circle"></i>
          </div>
          <div class="status-card-content">
            <div class="status-card-title">Diterima</div>
            <div class="status-card-number">{{ stats_distribusi.diterima or 0 }}</div>
            <div class="status-card-subtitle">Distribusi</div>
          </div>
        </div>
      </div>
      
      <!-- Kuota Buku Card -->
      <div class="status-card kuota" onclick="showKuotaModal()">
        <div class="status-card-trend">
          <i class="fas fa-chart-bar"></i>
        </div>
        <div class="status-card-header">
          <div class="status-card-icon">
            <i class="fas fa-book"></i>
          </div>
          <div class="status-card-content">
            <div class="status-card-title">Kuota Buku</div>
            <div class="status-card-number">{{ stats_distribusi.total_kuota or 0 }}</div>
            <div class="status-card-subtitle">Tersedia</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="scroll-indicator right" onclick="scrollCards('right')">
    <i class="fas fa-chevron-right text-gray-600"></i>
  </div>
</div>

<!-- Tombol Tambah Data -->
<div class="mb-6">
    {{ action_button("Tambah Riwayat Distribusi", onclick="showCreateModal()", icon="fas fa-plus", type="primary") }}
</div>

{% if data_distribusi %}
    {% call card("Data Riwayat Distribusi") %}
        <!-- DataTable Container -->
        <div class="overflow-x-auto">
            <table id="distribusiTable" class="min-w-full text-sm text-gray-700 table-auto">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="px-4 py-3 text-left font-medium text-gray-700">No</th>
                        <th class="px-4 py-3 text-left font-medium text-gray-700">Perpustakaan</th>
                        <th class="px-4 py-3 text-left font-medium text-gray-700">Kecamatan</th>
                        <th class="px-4 py-3 text-left font-medium text-gray-700">Desa</th>
                        <th class="px-4 py-3 text-left font-medium text-gray-700">Total Buku</th>
                        <th class="px-4 py-3 text-center font-medium text-gray-700">Status</th>
                        <th class="px-4 py-3 text-left font-medium text-gray-700">Tanggal</th>
                        <th class="px-4 py-3 text-center font-medium text-gray-700">Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    {% for distribusi in data_distribusi %}
                    <tr class="border-b hover:bg-gray-50 transition-colors">
                        <td class="px-4 py-3">{{ loop.index }}</td>
                        <td class="px-4 py-3 font-medium">{{ distribusi.perpus.nama if distribusi.perpus else '-' }}</td>
                        <td class="px-4 py-3">{{ distribusi.perpus.kecamatan if distribusi.perpus else '-' }}</td>
                        <td class="px-4 py-3">{{ distribusi.perpus.desa if distribusi.perpus else '-' }}</td>
                        <td class="px-4 py-3">
                            {% set total_buku = distribusi.detail_riwayat_distribusi | sum(attribute='jumlah') %}
                            {{ total_buku }} buku
                        </td>
                        <td class="px-4 py-3 text-center">
                            {% if distribusi.status == 'pengiriman' %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                    <i class="fas fa-truck mr-1"></i>
                                    Dalam Pengiriman
                                </span>
                            {% elif distribusi.status == 'diterima' %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    <i class="fas fa-check-circle mr-1"></i>
                                    Diterima
                                </span>
                            {% else %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                    {{ distribusi.status }}
                                </span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3">{{ distribusi.created_at.strftime('%d/%m/%Y') if distribusi.created_at else '-' }}</td>
                        <td class="px-4 py-3 text-center">
                            <div class="action-buttons">
                                <button onclick="showDetailModal({{ distribusi.id }})" 
                                        class="action-btn action-btn-detail"
                                        title="Detail">
                                    <i class="fas fa-eye"></i>
                                    <span>Detail</span>
                                </button>
                                <button onclick="showDeleteModal({{ distribusi.id }}, '{{ distribusi.perpus.nama if distribusi.perpus else 'Distribusi' }}')" 
                                        class="action-btn action-btn-delete"
                                        title="Hapus">
                                    <i class="fas fa-trash"></i>
                                    <span>Hapus</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% endcall %}
{% else %}
    {% call card() %}
        <div class="text-center py-8">
            <i class="fas fa-truck text-4xl text-gray-400 mb-4"></i>
            <h3 class="text-lg font-medium text-gray-600 mb-2">Belum Ada Data Distribusi</h3>
            <p class="text-gray-500">Riwayat distribusi akan muncul di sini ketika ada distribusi buku.</p>
        </div>
    {% endcall %}
{% endif %}

<!-- Modal Detail -->
<div id="detailModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-2/3 shadow-lg rounded-md bg-white max-h-screen overflow-y-auto">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-gray-900">Detail Distribusi</h3>
                <button type="button" onclick="closeModal('detailModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            <div id="detailContent">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>
</div>



<!-- Modal Delete -->
<div id="deleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/3 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Konfirmasi Hapus</h3>
            <p class="text-sm text-gray-500 mb-4">
                Apakah Anda yakin ingin menghapus data distribusi untuk "<span id="deleteDistribusiName" class="font-semibold"></span>"?
            </p>
            <p class="text-xs text-red-600 mb-6">Tindakan ini tidak dapat dibatalkan!</p>
            <div class="flex justify-center space-x-3">
                <button type="button" onclick="closeModal('deleteModal')" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
                    Batal
                </button>
                <button type="button" id="confirmDeleteBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">
                    Ya, Hapus
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Create -->
<div id="createModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-2/3 shadow-lg rounded-md bg-white max-h-screen overflow-y-auto">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-gray-900">Tambah Riwayat Distribusi Baru</h3>
                <button type="button" onclick="closeModal('createModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            <form id="createForm" method="POST" action="{{ url_for('superadmin.tambah_distribusi') }}" enctype="multipart/form-data">
                <div id="createContent">
                    <!-- Content will be loaded here -->
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeModal('createModal')" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
                        Batal
                    </button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                        Simpan Data
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Kuota Buku -->
<div id="kuotaModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-2/3 lg:w-1/2 shadow-lg rounded-md bg-white max-h-screen overflow-y-auto">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-semibold text-gray-900">Detail Kuota Buku per Subjek</h3>
                <button type="button" onclick="closeModal('kuotaModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                {% if kuota_per_subjek %}
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm text-gray-700">
                            <thead class="bg-blue-100 text-blue-800">
                                <tr>
                                    <th class="px-4 py-3 text-left font-medium">No</th>
                                    <th class="px-4 py-3 text-left font-medium">Subjek Buku</th>
                                    <th class="px-4 py-3 text-center font-medium">Kuota Tersedia</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in kuota_per_subjek %}
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="px-4 py-3">{{ loop.index }}</td>
                                    <td class="px-4 py-3 font-medium">{{ item.subjek_nama }}</td>
                                    <td class="px-4 py-3 text-center">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                            {{ item.total_kuota }} buku
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="bg-gray-50">
                                <tr>
                                    <th colspan="2" class="px-4 py-3 text-right font-semibold text-gray-700">Total:</th>
                                    <th class="px-4 py-3 text-center">
                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-bold bg-blue-500 text-white">
                                            {{ stats_distribusi.total_kuota or 0 }} buku
                                        </span>
                                    </th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-8">
                        <i class="fas fa-book text-4xl text-gray-400 mb-4"></i>
                        <h4 class="text-lg font-medium text-gray-600 mb-2">Tidak Ada Kuota Tersedia</h4>
                        <p class="text-gray-500">Belum ada kuota buku yang tersedia untuk distribusi.</p>
                    </div>
                {% endif %}
            </div>
            
            <div class="flex justify-end mt-6">
                <button type="button" onclick="closeModal('kuotaModal')" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded transition duration-200">
                    Tutup
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- DataTables JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.12.1/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.3.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.3.0/js/responsive.bootstrap5.min.js"></script>

<script>
// Distribution Form Variables
let subjekRowCount = 0;
let availableSubjects = [];
let availableDonations = [];

$(document).ready(function() {
    // Initialize DataTables
    $('#distribusiTable').DataTable({
        responsive: true,
        language: {
            url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/id.json',
            lengthMenu: "Tampilkan _MENU_ entri",
            search: "Cari:",
            info: "Menampilkan _START_ sampai _END_ dari _TOTAL_ entri",
            infoEmpty: "Menampilkan 0 sampai 0 dari 0 entri",
            infoFiltered: "(disaring dari _MAX_ total entri)",
            emptyTable: "Tidak ada data yang tersedia dalam tabel",
            zeroRecords: "Tidak ada catatan yang cocok ditemukan",
            paginate: {
                first: "Pertama",
                last: "Terakhir",
                next: '<i class="fa-solid fa-chevron-right"></i>',
                previous: '<i class="fa-solid fa-chevron-left"></i>'
            }
        },
        columnDefs: [
            { 
                orderable: false, 
                targets: [0, 8],
                className: "text-center"
            },
            {
                className: "text-center",
                targets: [0, 6, 8]
            }
        ],
        order: [[0, 'asc']],
        pageLength: 10,
        lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "Semua"]],
        dom: '<"flex flex-col lg:flex-row lg:items-center lg:justify-between mb-6 gap-4"<"flex-1"l><"flex-1 lg:text-right"f>>rtip'
    });
});

// Distribution Form Functions
function initializeDistributionForm() {
    console.log('Initializing distribution form...');
    
    // Reset variables
    subjekRowCount = 0;
    availableSubjects = [];
    availableDonations = [];
    
    // Clear previous content
    const container = document.getElementById('subjek_container');
    if (container) container.innerHTML = '';
    
    // Load data
    loadAvailableSubjects();
    loadAvailableDonations();
    
    // Setup add button event listener
    setTimeout(() => {
        const addBtn = document.getElementById('addSubjekButton');
        if (addBtn) {
            addBtn.onclick = function(e) {
                e.preventDefault();
                addSubjekRow();
            };
        }
    }, 100);
}

function loadAvailableSubjects() {
    fetch('/superadmin/api/subjects')
        .then(response => response.json())
        .then(data => {
            availableSubjects = data;
            console.log('Loaded subjects:', data.length);
            addSubjekRow(); // Add first row
        })
        .catch(error => {
            console.error('Error loading subjects:', error);
            showToast('Gagal memuat daftar subjek', 'error');
        });
}

function loadAvailableDonations() {
    fetch('/superadmin/api/available-donations')
        .then(response => response.json())
        .then(data => {
            availableDonations = data;
            console.log('Loaded donations:', data.length);
        })
        .catch(error => {
            console.error('Error loading donations:', error);
            showToast('Gagal memuat daftar donasi', 'error');
        });
}

function addSubjekRow() {
    console.log('Adding subjek row...');
    subjekRowCount++;
    const container = document.getElementById('subjek_container');
    
    if (!container) {
        console.error('subjek_container not found');
        return;
    }
    
    const rowHtml = `
        <div class="subjek-row border rounded-md p-4 mb-4 bg-white" data-row="${subjekRowCount}">
            <div class="flex justify-between items-center mb-3">
                <h5 class="font-medium text-gray-700">Subjek ${subjekRowCount}</h5>
                <button type="button" onclick="removeSubjekRow(${subjekRowCount})" 
                        class="text-red-600 hover:text-red-800">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Subjek Buku</label>
                    <select name="subjek_id[]" onchange="updateDonasiOptions(${subjekRowCount})" required
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">-- Pilih Subjek --</option>
                        ${availableSubjects.map(s => `<option value="${s.id}">${s.nama}</option>`).join('')}
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah yang Didistribusikan</label>
                    <input type="number" name="jumlah_distribusi[]" min="1" required
                           onchange="validateDistribution(${subjekRowCount})"
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            
            <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Pilih Donasi (Multiple)</label>
                <div class="donasi-container" id="donasi_container_${subjekRowCount}">
                    <p class="text-gray-500 text-sm">Pilih subjek terlebih dahulu</p>
                </div>
            </div>
            
            <div class="mt-3 p-3 bg-gray-50 rounded">
                <div class="text-sm text-gray-600">
                    <div>Total Tersedia: <span id="total_available_${subjekRowCount}">0</span> buku</div>
                    <div>Yang Didistribusikan: <span id="total_distributed_${subjekRowCount}">0</span> buku</div>
                    <div class="font-medium">Sisa: <span id="remaining_${subjekRowCount}">0</span> buku</div>
                </div>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', rowHtml);
    console.log('Subjek row added:', subjekRowCount);
}

function removeSubjekRow(rowId) {
    const row = document.querySelector(`[data-row="${rowId}"]`);
    if (row) {
        row.remove();
        updateDistributionSummary();
    }
}

function updateDonasiOptions(rowId) {
    const subjekSelect = document.querySelector(`[data-row="${rowId}"] select[name="subjek_id[]"]`);
    const donasiContainer = document.getElementById(`donasi_container_${rowId}`);
    const subjekId = subjekSelect.value;
    
    if (!subjekId) {
        donasiContainer.innerHTML = '<p class="text-gray-500 text-sm">Pilih subjek terlebih dahulu</p>';
        return;
    }
    
    // Filter donations by selected subjek
    const filteredDonations = availableDonations.filter(d => 
        d.details.some(detail => detail.subjek_id == subjekId && detail.kuota > 0)
    );
    
    if (filteredDonations.length === 0) {
        donasiContainer.innerHTML = '<p class="text-gray-500 text-sm">Tidak ada donasi tersedia untuk subjek ini</p>';
        return;
    }
    
    let donasiHtml = '<div class="space-y-2">';
    filteredDonations.forEach(donasi => {
        const detail = donasi.details.find(d => d.subjek_id == subjekId);
        donasiHtml += `
            <label class="flex items-center space-x-3 p-2 border rounded hover:bg-gray-50 cursor-pointer">
                <input type="checkbox" name="donasi_ids_${rowId}[]" value="${donasi.id}"
                       data-kuota="${detail.kuota}" data-detail-id="${detail.id}"
                       onchange="updateAvailableTotal(${rowId})"
                       class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                <div class="flex-1">
                    <div class="text-sm font-medium">${donasi.invoice}</div>
                    <div class="text-xs text-gray-500">${donasi.donatur} - Kuota: ${detail.kuota} buku</div>
                </div>
            </label>
        `;
    });
    donasiHtml += '</div>';
    
    donasiContainer.innerHTML = donasiHtml;
    updateAvailableTotal(rowId);
}

function updateAvailableTotal(rowId) {
    const checkboxes = document.querySelectorAll(`input[name="donasi_ids_${rowId}[]"]:checked`);
    let totalAvailable = 0;
    
    checkboxes.forEach(checkbox => {
        totalAvailable += parseInt(checkbox.getAttribute('data-kuota')) || 0;
    });
    
    document.getElementById(`total_available_${rowId}`).textContent = totalAvailable;
    validateDistribution(rowId);
}

function validateDistribution(rowId) {
    const jumlahInput = document.querySelector(`[data-row="${rowId}"] input[name="jumlah_distribusi[]"]`);
    const totalAvailable = parseInt(document.getElementById(`total_available_${rowId}`).textContent) || 0;
    const jumlahDistribusi = parseInt(jumlahInput.value) || 0;
    
    document.getElementById(`total_distributed_${rowId}`).textContent = jumlahDistribusi;
    
    const remaining = totalAvailable - jumlahDistribusi;
    document.getElementById(`remaining_${rowId}`).textContent = remaining;
    
    // Visual feedback
    const remainingSpan = document.getElementById(`remaining_${rowId}`);
    if (remaining < 0) {
        remainingSpan.className = 'text-red-600 font-bold';
        jumlahInput.classList.add('border-red-500');
    } else {
        remainingSpan.className = 'text-gray-600';
        jumlahInput.classList.remove('border-red-500');
    }
    
    updateDistributionSummary();
}

function updateDistributionSummary() {
    const rows = document.querySelectorAll('.subjek-row');
    let summaryHtml = '';
    let isValid = true;
    
    rows.forEach((row, index) => {
        const rowId = row.getAttribute('data-row');
        const subjekSelect = row.querySelector('select[name="subjek_id[]"]');
        const jumlahInput = row.querySelector('input[name="jumlah_distribusi[]"]');
        const totalAvailable = parseInt(document.getElementById(`total_available_${rowId}`).textContent) || 0;
        const jumlahDistribusi = parseInt(jumlahInput.value) || 0;
        
        if (subjekSelect.value && jumlahDistribusi > 0) {
            const subjekName = subjekSelect.options[subjekSelect.selectedIndex].text;
            const remaining = totalAvailable - jumlahDistribusi;
            
            summaryHtml += `
                <div class="flex justify-between items-center py-1">
                    <span>${subjekName}</span>
                    <span class="${remaining < 0 ? 'text-red-600' : 'text-gray-600'}">${jumlahDistribusi} buku</span>
                </div>
            `;
            
            if (remaining < 0) isValid = false;
        }
    });
    
    if (summaryHtml) {
        document.getElementById('summaryContent').innerHTML = summaryHtml;
        document.getElementById('distributionSummary').classList.remove('hidden');
    } else {
        document.getElementById('distributionSummary').classList.add('hidden');
    }
    
    // Enable/disable submit button based on validation
    const submitButton = document.querySelector('#createForm button[type="submit"]');
    if (submitButton) {
        submitButton.disabled = !isValid;
        if (!isValid) {
            submitButton.classList.add('opacity-50', 'cursor-not-allowed');
        } else {
            submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
        }
    }
}

function setupFormHandler() {
    const form = document.getElementById('createForm');
    if (form) {
        form.onsubmit = function(event) {
            event.preventDefault();
            
            // Prevent double submission
            const submitButton = event.target.querySelector('button[type="submit"]');
            if (submitButton.disabled) {
                return false;
            }
            
            // Disable submit button
            submitButton.disabled = true;
            submitButton.textContent = 'Menyimpan...';
            
            const formData = new FormData();
            formData.append('perpus_id', document.getElementById('perpus_id').value);
            formData.append('status', document.getElementById('status').value);
            
            // Collect all subjek data
            const rows = document.querySelectorAll('.subjek-row');
            const distributionData = [];
            
            rows.forEach(row => {
                const rowId = row.getAttribute('data-row');
                const subjekId = row.querySelector('select[name="subjek_id[]"]').value;
                const jumlahDistribusi = row.querySelector('input[name="jumlah_distribusi[]"]').value;
                const checkedDonations = row.querySelectorAll(`input[name="donasi_ids_${rowId}[]"]:checked`);
                
                if (subjekId && jumlahDistribusi && checkedDonations.length > 0) {
                    const donationData = [];
                    checkedDonations.forEach(checkbox => {
                        donationData.push({
                            donasi_id: checkbox.value,
                            detail_id: checkbox.getAttribute('data-detail-id'),
                            kuota: parseInt(checkbox.getAttribute('data-kuota'))
                        });
                    });
                    
                    distributionData.push({
                        subjek_id: subjekId,
                        jumlah_distribusi: parseInt(jumlahDistribusi),
                        donations: donationData
                    });
                }
            });
            
            formData.append('distribution_data', JSON.stringify(distributionData));
            
            // Submit to server
            fetch('/superadmin/riwayat-distribusi/tambah', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message, 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    showToast(data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Gagal menyimpan data distribusi', 'error');
            })
            .finally(() => {
                // Re-enable submit button
                submitButton.disabled = false;
                submitButton.textContent = 'Simpan Data';
            });
        };
    }
}

// Modal functions
function closeModal(modalId) {
    document.getElementById(modalId).classList.add('hidden');
    // Restore body scroll when closing any modal
    document.body.style.overflow = 'auto';
}

function showKuotaModal() {
    document.getElementById('kuotaModal').classList.remove('hidden');
}

function showDetailModal(distribusiId) {
    fetch(`/superadmin/riwayat-distribusi/detail/${distribusiId}`)
        .then(response => response.text())
        .then(data => {
            document.getElementById('detailContent').innerHTML = data;
            document.getElementById('detailModal').classList.remove('hidden');
            
            // Ensure image modal functions are available globally after content load
            setTimeout(() => {
                setupImageModalHandlers();
            }, 100);
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Gagal memuat detail distribusi', 'error');
        });
}

// Global image modal functions to handle bukti foto viewing
function setupImageModalHandlers() {
    // Make sure these functions are available globally
    window.showImageModal = function(imageSrc) {
        let imageModal = document.getElementById('imageModal');
        if (!imageModal) {
            // Create modal if it doesn't exist
            createImageModal();
            imageModal = document.getElementById('imageModal');
        }
        
        document.getElementById('modalImage').src = imageSrc;
        imageModal.classList.remove('hidden');
        // Prevent body scroll when modal is open
        document.body.style.overflow = 'hidden';
    };

    window.closeImageModal = function() {
        const imageModal = document.getElementById('imageModal');
        if (imageModal) {
            imageModal.classList.add('hidden');
            // Restore body scroll
            document.body.style.overflow = 'auto';
        }
    };
}

// Create image modal if it doesn't exist
function createImageModal() {
    if (!document.getElementById('imageModal')) {
        const modalHTML = `
            <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-[60] flex items-center justify-center" onclick="closeImageModal()">
                <div class="relative max-w-4xl max-h-screen p-4" onclick="event.stopPropagation()">
                    <button onclick="closeImageModal()" class="absolute top-2 right-2 text-white hover:text-gray-300 z-10 bg-black bg-opacity-50 rounded-full w-10 h-10 flex items-center justify-center">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                    <img id="modalImage" src="" alt="Bukti Foto" class="max-w-full max-h-full object-contain rounded shadow-lg">
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
    }
}

// Initialize image modal handlers on page load
document.addEventListener('DOMContentLoaded', function() {
    setupImageModalHandlers();
    createImageModal();
    
    // Close modal on Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeImageModal();
        }
    });
});

function showDeleteModal(distribusiId, perpusName) {
    document.getElementById('deleteDistribusiName').textContent = perpusName;
    document.getElementById('confirmDeleteBtn').onclick = function() {
        deleteDistribusi(distribusiId);
    };
    document.getElementById('deleteModal').classList.remove('hidden');
}

function deleteDistribusi(distribusiId) {
    fetch(`/superadmin/riwayat-distribusi/delete/${distribusiId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showToast(data.message, 'error');
        }
        closeModal('deleteModal');
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Gagal menghapus data distribusi', 'error');
        closeModal('deleteModal');
    });
}

// Show create modal - SIMPLIFIED
function showCreateModal() {
    fetch('/superadmin/riwayat-distribusi/tambah')
        .then(response => response.text())
        .then(data => {
            document.getElementById('createContent').innerHTML = data;
            document.getElementById('createModal').classList.remove('hidden');
            
            // Initialize form after content is loaded
            setTimeout(() => {
                initializeDistributionForm();
                setupFormHandler();
            }, 100);
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Gagal memuat form tambah distribusi', 'error');
        });
}

// Toast notification function
function showToast(message, type = 'info') {
    // Simple alert for now - you can replace with a proper toast library
    if (type === 'success') {
        alert('✅ ' + message);
    } else if (type === 'error') {
        alert('❌ ' + message);
    } else {
        alert('ℹ️ ' + message);
    }
}

// Status Cards Slider Functionality - copied from donasi.html
function scrollCards(direction) {
  const wrapper = document.getElementById('statusCardsWrapper');
  const cardWidth = 220; // Approximate card width including gap
  const scrollAmount = cardWidth * 2;
  
  if (direction === 'left') {
    wrapper.scrollBy({
      left: -scrollAmount,
      behavior: 'smooth'
    });
  } else if (direction === 'right') {
    wrapper.scrollBy({
      left: scrollAmount,
      behavior: 'smooth'
    });
  }
}

// Update scroll indicators visibility based on scroll position
function updateScrollIndicators() {
  const wrapper = document.getElementById('statusCardsWrapper');
  const leftIndicator = document.querySelector('.scroll-indicator.left');
  const rightIndicator = document.querySelector('.scroll-indicator.right');
  
  if (wrapper.scrollLeft <= 0) {
    leftIndicator.style.opacity = '0';
    leftIndicator.style.pointerEvents = 'none';
  } else {
    leftIndicator.style.opacity = '1';
    leftIndicator.style.pointerEvents = 'auto';
  }
  
  if (wrapper.scrollLeft >= wrapper.scrollWidth - wrapper.clientWidth) {
    rightIndicator.style.opacity = '0';
    rightIndicator.style.pointerEvents = 'none';
  } else {
    rightIndicator.style.opacity = '1';
    rightIndicator.style.pointerEvents = 'auto';
  }
}

// Initialize scroll indicators
document.addEventListener('DOMContentLoaded', function() {
  const wrapper = document.getElementById('statusCardsWrapper');
  
  // Check if scroll is needed
  if (wrapper.scrollWidth <= wrapper.clientWidth) {
    document.querySelectorAll('.scroll-indicator').forEach(indicator => {
      indicator.style.display = 'none';
    });
  }
  
  // Add scroll event listener
  wrapper.addEventListener('scroll', updateScrollIndicators);
  
  // Initial check
  updateScrollIndicators();
});

// Touch/swipe support for mobile
let startX = 0;
let scrollLeft = 0;

document.getElementById('statusCardsWrapper').addEventListener('touchstart', function(e) {
  startX = e.touches[0].pageX - this.offsetLeft;
  scrollLeft = this.scrollLeft;
});

document.getElementById('statusCardsWrapper').addEventListener('touchmove', function(e) {
  e.preventDefault();
  const x = e.touches[0].pageX - this.offsetLeft;
  const walk = (x - startX) * 2;
  this.scrollLeft = scrollLeft - walk;
});
</script>
{% endblock %}