{% extends "superadmin/base_superadmin.html" %}
{% from "superadmin/content_wrapper.html" import page_header, card, data_table, action_button %}

{% block title %}Pengajuan Perpustakaan Desa{% endblock %}

{% block extra_head %}
<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.12.1/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.3.0/css/responsive.bootstrap5.min.css">
<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
  .action-buttons {
    display: flex;
    gap: 4px;
    justify-content: center;
    flex-wrap: wrap;
  }
  
  .action-btn {
    padding: 4px 8px;
    font-size: 12px;
    border-radius: 4px;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 32px;
    height: 28px;
  }
  
  .action-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }
  
  .action-btn-detail {
    background-color: #3b82f6;
    color: white;
  }
  
  .action-btn-detail:hover {
    background-color: #2563eb;
    color: white;
  }
  
  .action-btn-edit {
    background-color: #f59e0b;
    color: white;
  }
  
  .action-btn-edit:hover {
    background-color: #d97706;
    color: white;
  }
  
  .action-btn-delete {
    background-color: #ef4444;
    color: white;
  }
  
  .action-btn-delete:hover {
    background-color: #dc2626;
    color: white;
  }
  
  .status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
  }
  
  .status-pending {
    background-color: #fef3c7;
    color: #92400e;
  }
  
  .status-approved {
    background-color: #d1fae5;
    color: #065f46;
  }
  
  .status-rejected {
    background-color: #fee2e2;
    color: #991b1b;
  }
  
  .priority-badge {
    padding: 3px 8px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
  }
  
  .priority-tinggi {
    background-color: #fee2e2;
    color: #991b1b;
  }
  
  .priority-sedang {
    background-color: #fef3c7;
    color: #92400e;
  }
  
  .priority-rendah {
    background-color: #d1fae5;
    color: #065f46;
  }

  @media (max-width: 768px) {
    .action-buttons {
      flex-direction: column;
      gap: 2px;
    }
    
    .action-btn {
      width: 100%;
      justify-content: flex-start;
      gap: 6px;
      padding: 6px 8px;
      font-size: 11px;
    }
    
    .action-btn span {
      display: inline;
    }
  }
  
  @media (min-width: 769px) {
    .action-btn span {
      display: none;
    }
  }

  /* Enhanced DataTables styling */
  .dataTables_wrapper {
    font-family: inherit;
  }
  
  .dataTables_length select,
  .dataTables_filter input {
    border: 1px solid #d1d5db !important;
    border-radius: 6px !important;
    padding: 6px 12px !important;
    font-size: 14px !important;
    background-color: white !important;
  }
  
  .dataTables_length select:focus,
  .dataTables_filter input:focus {
    outline: none !important;
    border-color: #3b82f6 !important;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
  }
  
  .dataTables_length,
  .dataTables_filter {
    margin-bottom: 1rem;
  }
  
  .dataTables_length label,
  .dataTables_filter label {
    font-weight: 500;
    color: #374151;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .dataTables_info {
    font-size: 14px;
    color: #6b7280;
    font-weight: 500;
    padding: 8px 0;
  }

  /* ENHANCED PAGINATION STYLING */
  .dataTables_wrapper .dataTables_paginate {
    margin-top: 16px !important;
    display: flex !important;
    justify-content: flex-end !important;
    align-items: center !important;
    font-size: 14px !important;
  }
  
  .dataTables_wrapper .dataTables_paginate .paginate_button,
  .dataTables_wrapper .dataTables_paginate .paginate_button:link,
  .dataTables_wrapper .dataTables_paginate .paginate_button:visited,
  .dataTables_wrapper .dataTables_paginate .paginate_button:active {
    padding: 8px 12px !important;
    margin: 0 2px !important;
    border-radius: 6px !important;
    border: 1px solid #d1d5db !important;
    background: white !important;
    background-image: none !important;
    color: #374151 !important;
    font-weight: 500 !important;
    text-decoration: none !important;
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    min-width: 40px !important;
    height: 40px !important;
    font-size: 14px !important;
    transition: all 0.2s ease !important;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05) !important;
    cursor: pointer !important;
  }
  
  .dataTables_wrapper .dataTables_paginate .paginate_button:hover:not(.current):not(.disabled) {
    background: #f8fafc !important;
    background-image: none !important;
    border-color: #94a3b8 !important;
    color: #1e293b !important;
    transform: translateY(-1px) !important;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
  }
  
  .dataTables_wrapper .dataTables_paginate .paginate_button.current,
  .dataTables_wrapper .dataTables_paginate .paginate_button.current:link,
  .dataTables_wrapper .dataTables_paginate .paginate_button.current:visited,
  .dataTables_wrapper .dataTables_paginate .paginate_button.current:active,
  .dataTables_wrapper .dataTables_paginate .paginate_button.current:focus,
  .dataTables_wrapper .dataTables_paginate .paginate_button.current:hover {
    background: #3b82f6 !important;
    background-image: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important;
    background-color: #3b82f6 !important;
    border: 1px solid #2563eb !important;
    border-color: #2563eb !important;
    color: white !important;
    font-weight: 600 !important;
    box-shadow: 0 3px 12px rgba(59, 130, 246, 0.4) !important;
    transform: none !important;
    z-index: 10 !important;
    position: relative !important;
  }
  
  .dataTables_wrapper .dataTables_paginate .paginate_button.disabled,
  .dataTables_wrapper .dataTables_paginate .paginate_button.disabled:hover,
  .dataTables_wrapper .dataTables_paginate .paginate_button.disabled:link,
  .dataTables_wrapper .dataTables_paginate .paginate_button.disabled:visited {
    opacity: 0.4 !important;
    cursor: not-allowed !important;
    background: #f9fafb !important;
    background-image: none !important;
    border-color: #e5e7eb !important;
    color: #9ca3af !important;
    transform: none !important;
    box-shadow: none !important;
  }

  /* Status Cards Slider Styles */
  .status-cards-container {
    position: relative;
    width: 100%;
    margin-bottom: 1.5rem;
  }
  
  .status-cards-wrapper {
    overflow-x: auto;
    scrollbar-width: none;
    -ms-overflow-style: none;
    scroll-behavior: smooth;
    padding: 0.25rem 0;
  }
  
  .status-cards-wrapper::-webkit-scrollbar {
    display: none;
  }
  
  .status-cards-grid {
    display: flex;
    gap: 0.75rem;
    min-width: max-content;
    padding: 0.25rem 0;
  }
  
  .status-card {
    background: white;
    border-radius: 10px;
    padding: 1rem;
    box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.06);
    border: 1px solid #e5e7eb;
    min-width: 160px;
    flex-shrink: 0;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }
  
  .status-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--card-color);
  }
  
  .status-card:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }
  
  .status-card.pending {
    --card-color: #f59e0b;
  }
  
  .status-card.approved {
    --card-color: #10b981;
  }
  
  .status-card.rejected {
    --card-color: #ef4444;
  }
  
  .status-card-header {
    display: flex;
    items-center;
    justify-content: between;
    margin-bottom: 0.5rem;
  }
  
  .status-card-icon {
    width: 2.25rem;
    height: 2.25rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    color: white;
    margin-right: 0.75rem;
    flex-shrink: 0;
  }
  
  .status-card.pending .status-card-icon {
    background: linear-gradient(135deg, #f59e0b, #d97706);
  }
  
  .status-card.approved .status-card-icon {
    background: linear-gradient(135deg, #10b981, #059669);
  }
  
  .status-card.rejected .status-card-icon {
    background: linear-gradient(135deg, #ef4444, #dc2626);
  }
  
  .status-card-content {
    flex: 1;
  }
  
  .status-card-title {
    font-size: 0.75rem;
    font-weight: 600;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.025em;
    margin-bottom: 0.125rem;
  }
  
  .status-card-number {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1f2937;
    line-height: 1;
    margin-bottom: 0.125rem;
  }
  
  .status-card-subtitle {
    font-size: 0.6875rem;
    color: #9ca3af;
    font-weight: 500;
  }
  
  .status-card-trend {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    font-size: 0.6875rem;
    color: var(--card-color);
    font-weight: 600;
  }
  
  /* Scroll Indicators */
  .scroll-indicator {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 2rem;
    height: 2rem;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 10;
    box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
    transition: all 0.2s ease;
    opacity: 0;
    pointer-events: none;
  }
  
  .scroll-indicator:hover {
    background: #f3f4f6;
    transform: translateY(-50%) scale(1.05);
  }
  
  .scroll-indicator.left {
    left: -1rem;
  }
  
  .scroll-indicator.right {
    right: -1rem;
  }
  
  .status-cards-container:hover .scroll-indicator {
    opacity: 1;
    pointer-events: auto;
  }
  
  /* Responsive Design */
  @media (min-width: 768px) {
    .status-cards-grid {
      justify-content: center;
    }
    
    .status-card {
      min-width: 180px;
    }
  }
  
  @media (min-width: 1024px) {
    .status-cards-grid {
      justify-content: space-between;
      flex-wrap: wrap;
    }
    
    .status-card {
      flex: 1;
      max-width: 200px;
      min-width: 180px;
    }
  }
  
  @media (max-width: 640px) {
    .status-card {
      min-width: 140px;
      padding: 0.875rem;
    }
    
    .status-card-number {
      font-size: 1.375rem;
    }
    
    .status-card-icon {
      width: 2rem;
      height: 2rem;
      font-size: 0.875rem;
      margin-right: 0.5rem;
    }
    
    .status-card-title {
      font-size: 0.6875rem;
    }
    
    .status-card-subtitle {
      font-size: 0.625rem;
    }
  }
</style>
{% endblock %}

{% block content %}
{{ page_header("Pengajuan Perpustakaan Desa", "Kelola pengajuan kebutuhan koleksi buku dari perpustakaan desa.") }}

<!-- Status Cards Section -->
<div class="status-cards-container">
  <div class="scroll-indicator left" onclick="scrollCards('left')">
    <i class="fas fa-chevron-left text-gray-600"></i>
  </div>
  
  <div class="status-cards-wrapper" id="statusCardsWrapper">
    <div class="status-cards-grid">
      <!-- Pending Card -->
      <div class="status-card pending">
        <div class="status-card-trend">
          <i class="fas fa-clock"></i>
        </div>
        <div class="status-card-header">
          <div class="status-card-icon">
            <i class="fas fa-hourglass-half"></i>
          </div>
          <div class="status-card-content">
            <div class="status-card-title">Menunggu</div>
            <div class="status-card-number">{{ stats_pengajuan.pending or 0 }}</div>
            <div class="status-card-subtitle">Pengajuan</div>
          </div>
        </div>
      </div>
      
      <!-- Approved Card -->
      <div class="status-card approved">
        <div class="status-card-trend">
          <i class="fas fa-check"></i>
        </div>
        <div class="status-card-header">
          <div class="status-card-icon">
            <i class="fas fa-check-circle"></i>
          </div>
          <div class="status-card-content">
            <div class="status-card-title">Disetujui</div>
            <div class="status-card-number">{{ stats_pengajuan.approved or 0 }}</div>
            <div class="status-card-subtitle">Pengajuan</div>
          </div>
        </div>
      </div>
      
      <!-- Rejected Card -->
      <div class="status-card rejected">
        <div class="status-card-trend">
          <i class="fas fa-times"></i>
        </div>
        <div class="status-card-header">
          <div class="status-card-icon">
            <i class="fas fa-times-circle"></i>
          </div>
          <div class="status-card-content">
            <div class="status-card-title">Ditolak</div>
            <div class="status-card-number">{{ stats_pengajuan.rejected or 0 }}</div>
            <div class="status-card-subtitle">Pengajuan</div>
          </div>
        </div>
      </div>
      
      <!-- Total Card -->
      <div class="status-card" style="--card-color: #6366f1;">
        <div class="status-card-trend">
          <i class="fas fa-chart-bar"></i>
        </div>
        <div class="status-card-header">
          <div class="status-card-icon" style="background: linear-gradient(135deg, #6366f1, #4f46e5);">
            <i class="fas fa-list-alt"></i>
          </div>
          <div class="status-card-content">
            <div class="status-card-title">Total</div>
            <div class="status-card-number">{{ stats_pengajuan.total or 0 }}</div>
            <div class="status-card-subtitle">Pengajuan</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="scroll-indicator right" onclick="scrollCards('right')">
    <i class="fas fa-chevron-right text-gray-600"></i>
  </div>
</div>

{% if data_pengajuan %}
    {% call card("Data Pengajuan Kebutuhan Koleksi") %}
        <!-- DataTable Container -->
        <div class="overflow-x-auto">
            <table id="pengajuanTable" class="min-w-full text-sm text-gray-700 table-auto">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="px-4 py-3 text-left font-medium text-gray-700">Perpustakaan</th>
                        <th class="px-4 py-3 text-left font-medium text-gray-700">Prioritas</th>
                        <th class="px-4 py-3 text-left font-medium text-gray-700">Total Buku</th>
                        <th class="px-4 py-3 text-left font-medium text-gray-700">Tanggal Pengajuan</th>
                        <th class="px-4 py-3 text-center font-medium text-gray-700">Status</th>
                        <th class="px-4 py-3 text-center font-medium text-gray-700">Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    {% for kebutuhan in data_pengajuan %}
                    <tr class="border-b hover:bg-gray-50 transition-colors">
                        <td class="px-4 py-3 font-medium">{{ kebutuhan.perpus.nama }} - {{ kebutuhan.perpus.kecamatan }}</td>
                        <td class="px-4 py-3">
                            <span class="priority-badge priority-{{ kebutuhan.prioritas }}">
                                {{ kebutuhan.prioritas }}
                            </span>
                        </td>
                        <td class="px-4 py-3">{{ kebutuhan.total_buku }} buku</td>
                        <td class="px-4 py-3">{{ kebutuhan.tanggal_pengajuan.strftime('%d/%m/%Y') }}</td>
                        <td class="px-4 py-3 text-center">
                            <span class="status-badge status-{{ kebutuhan.status }}">
                                {% if kebutuhan.status == 'pending' %}
                                    Menunggu
                                {% elif kebutuhan.status == 'approved' %}
                                    Disetujui
                                {% elif kebutuhan.status == 'rejected' %}
                                    Ditolak
                                {% endif %}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <div class="action-buttons">
                                <button onclick="showDetailModal({{ kebutuhan.id }})" 
                                        class="action-btn action-btn-detail"
                                        title="Detail">
                                    <i class="fas fa-eye"></i>
                                    <span>Detail</span>
                                </button>
                                <button onclick="showEditStatusModal({{ kebutuhan.id }}, '{{ kebutuhan.status }}')" 
                                        class="action-btn action-btn-edit"
                                        title="Edit Status">
                                    <i class="fas fa-edit"></i>
                                    <span>Edit Status</span>
                                </button>
                                <button onclick="confirmDelete({{ kebutuhan.id }}, '{{ kebutuhan.perpus.nama }}')" 
                                        class="action-btn action-btn-delete"
                                        title="Hapus">
                                    <i class="fas fa-trash"></i>
                                    <span>Hapus</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% endcall %}
{% else %}
    {% call card() %}
        <div class="text-center py-8">
            <i class="fas fa-file-alt text-4xl text-gray-400 mb-4"></i>
            <h3 class="text-lg font-medium text-gray-600 mb-2">Belum Ada Pengajuan</h3>
            <p class="text-gray-500">Belum ada pengajuan kebutuhan koleksi dari perpustakaan desa.</p>
        </div>
    {% endcall %}
{% endif %}

<!-- Modal Detail -->
<div id="detailModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-gray-900">Detail Pengajuan Kebutuhan Koleksi</h3>
                <button type="button" onclick="closeModal('detailModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            <div id="detailContent">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Modal Edit Status -->
<div id="editStatusModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/3 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-gray-900">Edit Status Pengajuan</h3>
                <button type="button" onclick="closeModal('editStatusModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            <form id="editStatusForm" method="POST">
                <div class="space-y-4">
                    <div>
                        <label for="status" class="block text-sm font-medium text-gray-700 mb-1">
                            Status <span class="text-red-500">*</span>
                        </label>
                        <select id="status" name="status" required
                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="pending">Menunggu</option>
                            <option value="approved">Disetujui</option>
                            <option value="rejected">Ditolak</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="pesan" class="block text-sm font-medium text-gray-700 mb-1">
                            Pesan (Opsional)
                        </label>
                        <textarea id="pesan" name="pesan" rows="3"
                                 class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500"
                                 placeholder="Masukkan pesan untuk perpustakaan..."></textarea>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeModal('editStatusModal')" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
                        Batal
                    </button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                        Simpan Perubahan
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Konfirmasi Hapus -->
<div id="deleteConfirmModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-2/5 lg:w-1/3 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                    <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
                    Konfirmasi Hapus
                </h3>
                <button type="button" onclick="closeModal('deleteConfirmModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            
            <div class="mb-6">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center">
                            <i class="fas fa-trash text-red-500 text-lg"></i>
                        </div>
                    </div>
                    <div class="ml-4 flex-1">
                        <h4 class="text-md font-medium text-gray-900 mb-2">Hapus Pengajuan Perpustakaan</h4>
                        <p class="text-sm text-gray-600 mb-3">
                            Apakah Anda yakin ingin menghapus pengajuan dari <strong id="deletePerpusName"></strong>?
                        </p>
                        <div class="bg-yellow-50 border border-yellow-200 rounded-md p-3">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-exclamation-circle text-yellow-400"></i>
                                </div>
                                <div class="ml-2">
                                    <h5 class="text-sm font-medium text-yellow-800">Data yang akan dihapus:</h5>
                                    <ul class="text-sm text-yellow-700 mt-1 list-disc list-inside">
                                        <li>Data pengajuan kebutuhan koleksi</li>
                                        <li>Semua detail subjek buku dalam pengajuan ini</li>
                                    </ul>
                                    <p class="text-sm text-yellow-800 mt-2 font-medium">
                                        <i class="fas fa-warning mr-1"></i>
                                        Tindakan ini tidak dapat dibatalkan!
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="closeModal('deleteConfirmModal')" 
                        class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded transition-colors duration-200">
                    <i class="fas fa-times mr-1"></i>
                    Batal
                </button>
                <button type="button" onclick="executeDelete()" 
                        class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded transition-colors duration-200">
                    <i class="fas fa-trash mr-1"></i>
                    Ya, Hapus
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- DataTables JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.12.1/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.3.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.3.0/js/responsive.bootstrap5.min.js"></script>

<script>
$(document).ready(function() {
    // Custom sorting for priority column
    $.fn.dataTable.ext.order['priority-order'] = function(settings, col) {
        return this.api().column(col, {order:'index'}).nodes().map(function(td, i) {
            var priority = $(td).find('.priority-badge').text().toLowerCase().trim();
            switch(priority) {
                case 'tinggi': return 1;
                case 'sedang': return 2;
                case 'rendah': return 3;
                default: return 4;
            }
        });
    };

    // Custom sorting for status column
    $.fn.dataTable.ext.order['status-order'] = function(settings, col) {
        return this.api().column(col, {order:'index'}).nodes().map(function(td, i) {
            var status = $(td).find('.status-badge').text().toLowerCase().trim();
            switch(status) {
                case 'menunggu': return 1;
                case 'disetujui': return 2;
                case 'ditolak': return 3;
                default: return 4;
            }
        });
    };

    // Initialize DataTables
    var table = $('#pengajuanTable').DataTable({
        responsive: true,
        language: {
            url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/id.json',
            lengthMenu: "Tampilkan _MENU_ entri",
            search: "Cari:",
            info: "Menampilkan _START_ sampai _END_ dari _TOTAL_ entri",
            infoEmpty: "Menampilkan 0 sampai 0 dari 0 entri",
            infoFiltered: "(disaring dari _MAX_ total entri)",
            emptyTable: "Tidak ada data yang tersedia dalam tabel",
            zeroRecords: "Tidak ada catatan yang cocok ditemukan",
            paginate: {
                first: "Pertama",
                last: "Terakhir",
                next: '<i class="fa-solid fa-chevron-right"></i>',
                previous: '<i class="fa-solid fa-chevron-left"></i>'
            }
        },
        columnDefs: [
            { 
                orderable: false, 
                targets: [5],
                className: "text-center"
            },
            {
                className: "text-center",
                targets: [4, 5]
            },
            {
                orderDataType: 'priority-order',
                targets: [1]
            },
            {
                orderDataType: 'status-order', 
                targets: [4]
            }
        ],
        order: [[4, 'asc'], [1, 'asc'], [3, 'desc']], // Status asc (menunggu first), Priority asc (tinggi first), then date desc
        pageLength: 10,
        lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "Semua"]],
        dom: '<"flex flex-col lg:flex-row lg:items-center lg:justify-between mb-6 gap-4"<"flex-1"l><"flex-1 lg:text-right"f>>rtip',
        drawCallback: function() {
            applyPaginationStyling();
        },
        initComplete: function() {
            $('.dataTables_length select').addClass('border-2 focus:border-blue-500');
            $('.dataTables_filter input').addClass('border-2 focus:border-blue-500').attr('placeholder', 'Masukkan kata kunci...');
            setTimeout(applyPaginationStyling, 100);
        }
    });
    
    $(document).on('click', '.dataTables_paginate .paginate_button', function() {
        setTimeout(applyPaginationStyling, 50);
    });
    
    table.on('page.dt', function() {
        setTimeout(applyPaginationStyling, 50);
    });
});

function applyPaginationStyling() {
    $('.dataTables_paginate .paginate_button').removeClass('pagination-active-override force-current-style');
    
    $('.dataTables_paginate .paginate_button').each(function() {
        var $btn = $(this);
        if (!$btn.hasClass('current') && !$btn.hasClass('previous') && !$btn.hasClass('next') && !$btn.hasClass('disabled')) {
            $btn.css({
                'background': 'white',
                'background-image': 'none',
                'border': '1px solid #d1d5db',
                'color': '#374151',
                'font-weight': '500'
            });
        }
    });
    
    var currentButtons = $('.dataTables_paginate .paginate_button.current, .dataTables_paginate .paginate_button[aria-current="page"]');
    
    currentButtons.each(function() {
        var $btn = $(this);
        $btn.addClass('pagination-active-override force-current-style current');
        $btn.css({
            'background': '#3b82f6',
            'background-image': 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)',
            'background-color': '#3b82f6',
            'border': '1px solid #2563eb',
            'border-color': '#2563eb',
            'color': 'white',
            'font-weight': '600',
            'box-shadow': '0 3px 12px rgba(59, 130, 246, 0.4)',
            'z-index': '10',
            'position': 'relative'
        });
        $btn.attr('aria-current', 'page');
        $btn.attr('data-current', 'true');
    });
    
    customizePagination();
}

function customizePagination() {
    const prevButton = $('.dataTables_paginate .paginate_button.previous');
    const nextButton = $('.dataTables_paginate .paginate_button.next');
    
    if (prevButton.length && !prevButton.find('i').length) {
        prevButton.html('<i class="fa-solid fa-chevron-left mr-1"></i> Sebelumnya');
    }
    
    if (nextButton.length && !nextButton.find('i').length) {
        nextButton.html('Selanjutnya <i class="fa-solid fa-chevron-right ml-1"></i>');
    }
}

// Modal functions
function closeModal(modalId) {
    document.getElementById(modalId).classList.add('hidden');
}

function showDetailModal(pengajuanId) {
    // Load detail content via AJAX
    fetch(`/superadmin/pengajuan-perpusdes/detail/${pengajuanId}`)
        .then(response => response.text())
        .then(data => {
            document.getElementById('detailContent').innerHTML = data;
            document.getElementById('detailModal').classList.remove('hidden');
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Gagal memuat detail pengajuan', 'error');
        });
}

function showEditStatusModal(pengajuanId, currentStatus) {
    // Reset form
    document.getElementById('status').value = currentStatus;
    document.getElementById('pesan').value = '';
    
    // Load current data to populate pesan field
    fetch(`/superadmin/pengajuan-perpusdes/detail/${pengajuanId}`)
        .then(response => response.text())
        .then(data => {
            // Extract pesan from response if needed
            const parser = new DOMParser();
            const doc = parser.parseFromString(data, 'text/html');
            const pesanElement = doc.querySelector('[data-pesan]');
            if (pesanElement) {
                const pesanValue = pesanElement.textContent.trim();
                if (pesanValue !== 'Belum ada pesan') {
                    document.getElementById('pesan').value = pesanValue;
                }
            }
        })
        .catch(error => {
            console.error('Error loading current data:', error);
        });
    
    document.getElementById('editStatusForm').action = `/superadmin/pengajuan-perpusdes/update-status/${pengajuanId}`;
    document.getElementById('editStatusModal').classList.remove('hidden');
}

// Handle edit status form submission
document.getElementById('editStatusForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const actionUrl = this.action;
    
    fetch(actionUrl, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showToast(data.message, 'error');
        }
        closeModal('editStatusModal');
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Gagal menyimpan perubahan', 'error');
    });
});

// Delete confirmation and execution - Updated to use modal
let pendingDeleteId = null;

function confirmDelete(pengajuanId, perpusNama) {
    // Store the ID for later use
    pendingDeleteId = pengajuanId;
    
    // Update modal content
    document.getElementById('deletePerpusName').textContent = perpusNama;
    
    // Show modal
    document.getElementById('deleteConfirmModal').classList.remove('hidden');
}

function executeDelete() {
    if (pendingDeleteId) {
        deletePengajuan(pendingDeleteId);
        closeModal('deleteConfirmModal');
        pendingDeleteId = null;
    }
}

function deletePengajuan(pengajuanId) {
    // Show loading state on delete button
    const deleteBtn = document.querySelector('#deleteConfirmModal button[onclick="executeDelete()"]');
    const originalText = deleteBtn.innerHTML;
    deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Menghapus...';
    deleteBtn.disabled = true;

    fetch(`/superadmin/pengajuan-perpusdes/delete/${pengajuanId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showToast(data.message, 'error');
            // Reset button state
            deleteBtn.innerHTML = originalText;
            deleteBtn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Gagal menghapus pengajuan', 'error');
        // Reset button state
        deleteBtn.innerHTML = originalText;
        deleteBtn.disabled = false;
    });
}

// Enhanced modal close function
function closeModal(modalId) {
    document.getElementById(modalId).classList.add('hidden');
    
    // Reset pending delete ID when closing delete modal
    if (modalId === 'deleteConfirmModal') {
        pendingDeleteId = null;
        
        // Reset delete button state
        const deleteBtn = document.querySelector('#deleteConfirmModal button[onclick="executeDelete()"]');
        if (deleteBtn) {
            deleteBtn.innerHTML = '<i class="fas fa-trash mr-1"></i> Ya, Hapus';
            deleteBtn.disabled = false;
        }
    }
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modals = ['detailModal', 'editStatusModal', 'deleteConfirmModal'];
    modals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (event.target === modal) {
            closeModal(modalId);
        }
    });
}

// Close modal with Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const modals = ['detailModal', 'editStatusModal', 'deleteConfirmModal'];
        modals.forEach(modalId => {
            const modal = document.getElementById(modalId);
            if (!modal.classList.contains('hidden')) {
                closeModal(modalId);
            }
        });
    }
});
</script>
{% endblock %}
